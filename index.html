<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Custom Dog Charm Design</title>
    <script src="config.js"></script>
    <script src="supabase-quiz-integration.js"></script>
    <script>
        // Debug: Check if config loaded immediately
        console.log('Config check after script load:');
        console.log('window.CONFIG:', window.CONFIG);
        console.log('window.OPENAI_API_KEY:', window.OPENAI_API_KEY);
        
        // Also check after a short delay in case it's async
        setTimeout(() => {
            console.log('Config check after 1 second:');
            console.log('window.CONFIG:', window.CONFIG);
            console.log('window.OPENAI_API_KEY:', window.OPENAI_API_KEY);
        }, 1000);
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Avenir Next', 'Avenir', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 300;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            /* Iframe optimizations */
            overflow-x: auto;
            overflow-y: auto;
        }

        /* Iframe-specific optimizations */
        @media (max-width: 1200px) {
            body {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }
        }

        @media (max-width: 900px) {
            body {
                padding: 5px;
                padding-top: 10px;
            }
        }

        .container {
            background: white;
            border: 1px solid #000000;
            box-shadow: 0 0 0 1px #000000;
            max-width: 600px;
            width: 100%;
            padding: 40px;
            position: relative;
            overflow: hidden;
            transition: max-width 0.5s ease;
            /* Iframe optimizations */
            min-width: 320px;
            box-sizing: border-box;
        }

        .container.results-mode {
            max-width: 1450px; /* Increased to accommodate wider ecommerce layout */
        }

        /* Container responsive optimizations */
        @media (max-width: 1500px) {
            .container.results-mode {
                max-width: 95vw;
            }
        }

        @media (max-width: 1200px) {
            .container {
                padding: 30px;
            }
            .container.results-mode {
                max-width: 98vw;
            }
        }

        @media (max-width: 900px) {
            .container {
                padding: 20px;
                border: none;
                box-shadow: none;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
                margin: 0;
            }
        }

        @media (max-width: 400px) {
            .container {
                padding: 10px;
            }
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #f0f0f0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #DAE0FF, #C8D4FF);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Swimming Fish Logo Animation - Smooth Fade Transitions */
        .swimming-logo-container {
            position: relative;
            width: 100%;
            height: 40px;
            overflow: hidden;
            margin: 3px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .swimming-logo {
            position: absolute;
            height: 30px;
            width: auto;
            animation: fishSwim 8s linear infinite;
            transform-origin: center;
            will-change: transform, opacity;
        }
        
        @keyframes fishSwim {
            /* Start centered, fully visible */
            0% {
                transform: translateX(0%) translateY(0px) rotate(0deg);
                opacity: 1;
            }
            
            /* Swimming right with slight wave motion */
            15% {
                transform: translateX(50%) translateY(2px) rotate(1deg);
                opacity: 1;
            }
            
            30% {
                transform: translateX(100%) translateY(-2px) rotate(-1deg);
                opacity: 1;
            }
            
            /* Start fading out as it approaches right edge */
            40% {
                transform: translateX(150%) translateY(1px) rotate(1deg);
                opacity: 0.8;
            }
            
            /* Completely fade out before the position reset */
            49% {
                transform: translateX(200%) translateY(0px) rotate(0deg);
                opacity: 0;
            }
            
            /* Instantly move to far left while invisible */
            51% {
                transform: translateX(-200%) translateY(0px) rotate(0deg);
                opacity: 0;
            }
            
            /* Start fading in from left side */
            60% {
                transform: translateX(-150%) translateY(-1px) rotate(-1deg);
                opacity: 0.8;
            }
            
            /* Fully visible again */
            70% {
                transform: translateX(-100%) translateY(2px) rotate(1deg);
                opacity: 1;
            }
            
            85% {
                transform: translateX(-50%) translateY(-2px) rotate(-1deg);
                opacity: 1;
            }
            
            /* Back to center, fully visible */
            100% {
                transform: translateX(0%) translateY(0px) rotate(0deg);
                opacity: 1;
            }
        }

        /* Fish swimming animation - REMOVED: Fish only appears during AI loading */

        .question-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .question-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #000000;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 300;
            letter-spacing: -0.5px;
        }

        h2 {
            color: #000000;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 300;
            letter-spacing: -0.3px;
        }

        p {
            color: #000000;
            margin-bottom: 30px;
            font-size: 18px;
            line-height: 1.6;
            font-weight: 300;
        }

        /* Typography responsive optimizations */
        @media (max-width: 900px) {
            h1 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            h2 {
                font-size: 20px;
                margin-bottom: 20px;
            }
            
            p {
                font-size: 16px;
                margin-bottom: 20px;
                line-height: 1.5;
            }
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 22px;
            }
            
            h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }
        }

        .options {
            margin-bottom: 30px;
        }

        .option {
            border: 1px solid #000000;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-size: 16px;
            font-weight: 300;
            position: relative;
            overflow: hidden;
        }

        .option:hover {
            background: #f8f8f8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .option.selected {
            background: #000000;
            color: white;
        }

        .option.selected:hover {
            background: #333333;
        }

        .option-with-image {
            display: flex;
            align-items: center;
            padding: 15px;
        }

        .option-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
            font-size: 16px;
            font-weight: 300;
        }

        /* Multi-select options */
        .multi-select .option.selected {
            background: #000000;
            color: white;
        }

        .multi-select .option.selected::after {
            content: 'âœ“';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            justify-content: space-between;
            align-items: center;
        }

        .btn-primary, .btn-secondary {
            padding: 15px 30px;
            border: 1px solid #000000;
            background: white;
            color: #000000;
            cursor: pointer;
            font-size: 16px;
            font-weight: 300;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #DAE0FF, #C8D4FF);
            color: #333;
            flex: 1;
            max-width: 200px;
            margin-left: auto;
            border: 1px solid #DAE0FF;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #C8D4FF, #B8C8FF);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(218, 224, 255, 0.4);
        }

        .btn-primary:disabled {
            background: #cccccc;
            color: #666666;
            border-color: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: white;
            color: #000000;
        }

        .btn-secondary:hover {
            background: #f8f8f8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-primary svg, .btn-secondary svg {
            width: 16px;
            height: 16px;
        }

        /* Button responsive optimizations */
        @media (max-width: 600px) {
            .button-group {
                gap: 10px;
            margin-top: 30px;
            }
            
            .btn-primary, .btn-secondary {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 100px;
            }
        }

        /* File upload styles */
        .file-upload {
            border: 2px dashed #000000;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .file-upload:hover {
            background: #f0f0f0;
            border-color: #333333;
        }

        .file-upload.dragover {
            background: #e8f4fd;
            border-color: #007acc;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-label {
            cursor: pointer;
            display: block;
        }

        .file-upload-label strong {
            display: block;
            font-size: 18px;
            margin-bottom: 8px;
            color: #000000;
            font-weight: 400;
        }

        .file-upload-instructions {
            color: #666666;
            font-size: 14px;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .file-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .file-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: white;
            padding: 4px;
        }

        .file-preview-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            display: block;
        }

        .file-preview-single {
            width: 200px;
            height: 200px;
        }

        /* Text input styles */
        textarea, input[type="text"], input[type="email"], input[type="tel"] {
            width: 100%;
            padding: 15px;
            border: 1px solid #000000;
            font-size: 16px;
            font-family: inherit;
            font-weight: 300;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        input[type="text"], input[type="email"], input[type="tel"] {
            min-height: auto;
            height: 50px;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #333333;
        }

        textarea::placeholder, input::placeholder {
            color: #999999;
            font-weight: 300;
        }

        .skip-link {
            text-align: center;
            margin-bottom: 20px;
        }

        .skip-link a {
            color: #666666;
            text-decoration: none;
            font-size: 14px;
            border-bottom: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .skip-link a:hover {
            color: #000000;
            border-bottom-color: #000000;
        }

        /* Results and completion styles */
        .completion-message {
            text-align: center;
            padding: 40px 0;
        }

        .completion-message h1 {
            color: #000000;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .completion-message p {
            color: #666666;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .results {
            margin-top: 40px;
            text-align: left;
        }

        .results-list {
            list-style: none;
            padding: 0;
        }

        .results-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
        }

        .results-list li:last-child {
            border-bottom: none;
        }

        .results-list strong {
            color: #000000;
            font-weight: 400;
        }

        /* Loading and generation states */
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666666;
        }

        .loading-indicator.show {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            margin-right: 10px;
            vertical-align: middle;
        }

        .loading-spinner svg {
            width: 100%;
            height: 100%;
            animation: fishSwim 3s linear infinite;
        }

        /* Image generation results */
        .image-results {
            margin-top: 30px;
        }

        .generated-image {
                max-width: 100%;
            height: auto;
                border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .image-container {
            text-align: center;
                margin: 20px 0;
        }

        .regenerate-btn {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .regenerate-btn:hover {
            background: #e8e8e8;
            border-color: #ccc;
        }

        .btn-regenerate {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #DAE0FF;
            color: #333;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 400;
            font-family: 'Avenir Next', sans-serif;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 200px;
            box-shadow: 0 2px 4px rgba(218, 224, 255, 0.1);
        }

        .btn-regenerate:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(218, 224, 255, 0.2);
            border-color: #C8D4FF;
        }

        .btn-regenerate:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(218, 224, 255, 0.1);
        }

        .btn-add-photos {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #DAE0FF;
            color: #333;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 400;
            font-family: 'Avenir Next', sans-serif;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(218, 224, 255, 0.1);
        }

        .btn-add-photos:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(218, 224, 255, 0.2);
            border-color: #C8D4FF;
        }

        .btn-add-photos:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(218, 224, 255, 0.1);
        }

        /* Remove photo button */
        .btn-remove-photo {
            background: transparent;
            color: #000;
            border: none;
            border-radius: 50%;
            padding: 4px;
            font-size: 16px;
            font-weight: bold;
            font-family: 'Avenir Next', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 0;
            margin-left: 8px;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
        }

        .btn-remove-photo:hover {
            background: #f0f0f0;
            color: #000;
            transform: none;
            box-shadow: none;
        }

        .btn-remove-photo:active {
            background: #e0e0e0;
            transform: none;
            box-shadow: none;
        }

        /* Responsive optimizations for file upload */
        @media (max-width: 600px) {
            .file-upload {
                padding: 30px 15px;
            }
            
            .file-upload-label strong {
                font-size: 16px;
            }
            
            .file-upload-instructions {
                font-size: 13px;
            }
        }

        /* Responsive optimizations for text inputs */
        @media (max-width: 600px) {
            textarea, input[type="text"], input[type="email"], input[type="tel"] {
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            textarea {
                min-height: 100px;
            }
        }

        /* Additional mobile optimizations */
        @media (max-width: 400px) {
            .option {
                padding: 15px;
                font-size: 15px;
            }
            
            .option-with-image {
                padding: 12px;
            }
            
            .option-image {
                width: 50px;
                height: 50px;
                margin-right: 12px;
            }
            
            .completion-message h1 {
                font-size: 26px;
            }
            
            .completion-message p {
                font-size: 16px;
            }
        }

        /* High DPI display optimizations */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .option-image {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
            
            .file-preview {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                border: none;
                box-shadow: none;
                max-width: none;
                padding: 20px;
            }
            
            .progress-bar {
                display: none;
            }
            
            .button-group {
                display: none;
            }
            
            .question-container:not(.active) {
                display: none;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for better accessibility */
        .option:focus,
        .btn-primary:focus,
        .btn-secondary:focus,
        textarea:focus,
        input:focus {
            outline: 2px solid #007acc;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .option {
                border-width: 2px;
            }
            
            .btn-primary,
            .btn-secondary {
                border-width: 2px;
            }
            
            textarea,
            input {
                border-width: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>

        <!-- Question 1: Upload Dog Photo -->
        <div class="question-container active" data-question="Q1">
            <h2>Upload a picture of your dog</h2>
            <p>Share a photo of your furry friend so we can create a custom charm that captures their unique personality!</p>
            <div class="file-upload">
                <input type="file" id="dog-photo" accept="image/*" onchange="handleFileUpload('dog-photo')">
                <label for="dog-photo" class="file-upload-label">
                    <strong>Drag & drop your dog's photo here</strong>
                    <span class="file-upload-instructions">or click to browse your files</span>
                </label>
                <div class="file-info" id="dog-photo-info"></div>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="nextQuestion()">
                    Continue
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Question 2: Dog's Name -->
        <div class="question-container" data-question="Q2">
            <h2>What's your dog's name?</h2>
            <p>We'd love to know what to call your special pup! (This is optional)</p>
            <input type="text" id="dog-name" placeholder="Enter your dog's name..." onkeyup="checkTextInput()">
            <div class="skip-link">
                <a href="#" onclick="skipTextInput(); return false;">Skip this step</a>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </button>
                <button class="btn-primary" onclick="nextQuestion()">
                    Continue
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Question 3: About Your Dog -->
        <div class="question-container" data-question="Q3">
            <h2>Tell us a little bit about your dog</h2>
            <p>Share what makes your dog special - their personality, favorite activities, quirks, or anything that captures who they are! (This is optional)</p>
            <textarea id="dog-description" placeholder="For example: loves playing fetch, has the softest ears, always greets everyone with a wagging tail, sleeps in funny positions..." onkeyup="checkTextInput()"></textarea>
            <div class="skip-link">
                <a href="#" onclick="skipTextInput(); return false;">Skip this step</a>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </button>
                <button class="btn-primary" onclick="nextQuestion()">
                    Continue
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Materials Question -->
        <div class="question-container" data-question="materials">
            <h2>Choose your charm material</h2>
            <p>Select the premium material for your custom dog charm</p>
            <div class="options">
                <div class="option option-with-image" onclick="selectOption(this, 'sterling-silver')">
                    <img src="images/questions/materials/sterling-silver.jpg" alt="Sterling Silver" class="option-image">
                    <div class="option-text">
                        <strong>Sterling Silver</strong><br>
                        Classic, elegant, and timeless
                    </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, '14k-gold')">
                    <img src="images/questions/materials/14k-gold.jpg" alt="14K Gold" class="option-image">
                    <div class="option-text">
                        <strong>14K Gold</strong><br>
                        Luxurious, warm, and prestigious
                    </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'gold-plated')">
                    <img src="images/questions/materials/gold-plated.jpg" alt="Gold Plated" class="option-image">
                    <div class="option-text">
                        <strong>Gold Plated</strong><br>
                        Beautiful gold look, budget-friendly
                    </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'help-decide')">
                    <img src="images/questions/materials/help-decide.jpg" alt="Help Me Decide" class="option-image">
                    <div class="option-text">
                        <strong>Help Me Decide</strong><br>
                        Let our experts recommend the best material
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </button>
                <button class="btn-primary" onclick="nextQuestion()" disabled>
                    Continue
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Contact Info -->
        <div class="question-container" data-question="contact">
            <h2>How can we reach you?</h2>
            <p>We'll send your custom dog charm design mockup and updates</p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 400; color: #000;">Email address *</label>
                <input type="email" id="contact-email" placeholder="your@email.com" required style="margin-bottom: 15px;" onkeyup="validateContactForm()">
        </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 400; color: #000;">Phone number (optional)</label>
                <input type="tel" id="contact-phone" placeholder="+1 (555) 123-4567" onkeyup="validateContactForm()">
                <div style="font-size: 14px; color: #666; margin-top: 5px;">For text updates when your design is ready</div>
            </div>
            
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </button>
                <button class="btn-primary" onclick="validateContact()" disabled>
                    Submit
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Completion -->
        <div class="question-container" data-question="complete">
            <div class="completion-message">
                <h1>You're all set!</h1>
                <p style="font-size: 16px; margin-top: 20px;">Keep an eye on your inbox - you're going to love what we create for your furry friend!</p>
                
                <div style="margin: 25px 0; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border-left: 4px solid #6c757d;">
                    <p style="margin: 0; font-size: 14px; color: #333; line-height: 1.5;">
                        <strong>Community Design Share:</strong> Taiyaki is a community where we showcase beautiful custom designs to inspire other pet parents. You can opt out of design sharing anytime in your account settings if you prefer to keep your design private.
                    </p>
                </div>
                
                <!-- Loading indicator for image generation -->
                <div class="loading-indicator" id="loadingIndicator">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Creating your custom charm design...
                        <div class="swimming-logo-container" style="margin-top: 15px;">
                            <svg class="swimming-logo" version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300.000000 166.000000" preserveAspectRatio="xMidYMid meet">
                                <g transform="translate(0.000000,166.000000) scale(0.100000,-0.100000)" fill="#DAE0FF" stroke="none">
                                    <path d="M186 1478 c16 -222 84 -401 209 -547 25 -29 45 -56 43 -60 -2 -3 -29
                                    -50 -61 -104 -96 -161 -171 -366 -202 -554 l-7 -42 94 40 c126 55 255 127 363
                                    204 95 68 295 249 295 267 0 6 -17 25 -37 43 l-38 33 -90 -87 c-50 -47 -125
                                    -112 -168 -144 -87 -66 -246 -162 -254 -154 -10 11 40 143 95 250 30 60 81
                                    144 113 187 l58 79 -37 31 c-94 77 -189 226 -231 364 -31 102 -31 103 47 61
                                    144 -79 302 -225 501 -463 112 -134 297 -316 401 -393 367 -273 719 -319 1070
                                    -138 162 83 355 258 469 423 62 90 64 70 -28 200 -65 92 -200 232 -287 298
                                    -183 140 -353 200 -559 200 -285 -1 -579 -132 -823 -367 -106 -101 -105 -100
                                    -40 -146 l29 -21 92 89 c215 204 461 319 707 330 150 6 234 -11 365 -76 156
                                    -77 299 -201 416 -360 l47 -65 -31 -45 c-17 -25 -67 -84 -112 -130 -206 -215
                                    -424 -321 -660 -322 -333 -2 -639 196 -1026 661 -217 260 -428 424 -644 500
                                    -27 10 -58 21 -67 25 -15 6 -16 0 -12 -67z"/>
                                    <path d="M2194 1090 c-35 -14 -64 -59 -64 -99 0 -86 80 -141 154 -106 130 62
                                    44 259 -90 205z"/>
                                </g>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- Image results container -->
                <div class="image-results" id="imageResults">
                    <!-- Generated images will appear here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestion = 'Q1';
        let currentQuestionIndex = 0;
        let questionFlow = ['Q1', 'Q2', 'Q3', 'materials', 'contact', 'complete'];
        let questionHistory = [];
        let formData = {};
        let backgroundImagePromise = null;
        
        // Store the actual image generation prompts for accurate story generation
        let imageGenerationPrompts = {
            design1: '',
            design2: '',
            regenerated: {}
        };

        // Initialize the quiz
        function initializeQuiz() {
            // Always start fresh - no saved progress
            showQuestion('Q1');
            updateProgress();

            // Set up file upload handlers
            setupFileUploadHandlers();
        }

        // Set up drag and drop for file uploads
        function setupFileUploadHandlers() {
            const fileUpload = document.querySelector('.file-upload');
            if (fileUpload) {
                fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                    this.classList.add('dragover');
                });
                
                fileUpload.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });
                
                fileUpload.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const fileInput = this.querySelector('input[type="file"]');
                        fileInput.files = files;
                        handleFileUpload(fileInput.id);
                    }
                });
            }
        }

        // Handle file upload
        function handleFileUpload(inputId) {
            const input = document.getElementById(inputId);
            const file = input.files[0];
            
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please upload an image file.');
                    return;
                }
                
                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB.');
                    return;
                }
                
                // Store file info
                formData.dogPhoto = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    lastModified: file.lastModified
                };
                
                // Show file info
                const fileInfo = document.getElementById(inputId + '-info');
                if (fileInfo) {
                    fileInfo.innerHTML = `
                        <strong>Uploaded:</strong> ${file.name}
                        <button onclick="removePhoto('${inputId}')" class="btn-remove-photo" title="Remove photo">Ã—</button>
                        <br><small>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                    `;
                    fileInfo.classList.add('show');
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Store the image data for later use
                        formData.dogPhotoData = e.target.result;
                        
                        // Create preview
                        const preview = document.createElement('img');
                        preview.src = e.target.result;
                        preview.className = 'file-preview';
                        preview.alt = 'Photo preview';
                        preview.style.maxWidth = '200px';
                        preview.style.maxHeight = '200px';
                        preview.style.marginTop = '10px';
                        preview.style.borderRadius = '8px';
                        preview.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                        fileInfo.appendChild(preview);
                    };
                    reader.readAsDataURL(file);
                }
                
                // Ensure Continue button is enabled after photo upload
                const continueBtn = document.querySelector('.question-container.active .btn-primary');
                if (continueBtn) {
                    continueBtn.disabled = false;
                    console.log('Continue button enabled after photo upload');
                }
            }
        }

        // Remove uploaded photo
        function removePhoto(inputId) {
            // Clear the file input
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
            }
            
            // Clear the file info display
            const fileInfo = document.getElementById(inputId + '-info');
            if (fileInfo) {
                fileInfo.innerHTML = '';
                fileInfo.classList.remove('show');
            }
            
            // Clear stored photo data
            if (formData.dogPhoto) {
                delete formData.dogPhoto;
            }
            if (formData.dogPhotoData) {
                delete formData.dogPhotoData;
            }
            
            console.log('Photo removed successfully');
        }

        // Create elegant photo gallery
        // No longer needed for single photo uploads

        // Add more photos function
        // No longer needed for single photo uploads

        // Recreate gallery with all photos (for adding more photos)
        // No longer needed for single photo uploads

        // Show specific question
        function showQuestion(questionId) {
            // Hide all questions
            document.querySelectorAll('.question-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Show target question
            const targetQuestion = document.querySelector(`[data-question="${questionId}"]`);
            if (targetQuestion) {
                targetQuestion.classList.add('active');
                currentQuestion = questionId;
                
                // Update current question index
                currentQuestionIndex = questionFlow.indexOf(questionId);
                
                updateProgress();
            }
        }

        // Update progress bar
        function updateProgress() {
            const totalQuestions = questionFlow.length;
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.querySelector('.progress-fill').style.width = progress + '%';
        }

        // Navigate to next question
        function nextQuestion() {
            console.log('nextQuestion called, current question:', currentQuestion);
            console.log('formData:', formData);
            
            // Save current question data to memory (not localStorage)
            saveCurrentQuestionData();
            
            // Add current question to history
            if (!questionHistory.includes(currentQuestion)) {
                questionHistory.push(currentQuestion);
            }
            
            // Move to next question
            if (currentQuestionIndex < questionFlow.length - 1) {
                currentQuestionIndex++;
                showQuestion(questionFlow[currentQuestionIndex]);
            }
        }

        // Navigate to previous question
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(questionFlow[currentQuestionIndex]);
            }
        }

        // Save current question data to memory only
        function saveCurrentQuestionData() {
            switch (currentQuestion) {
                case 'Q2':
                    const dogName = document.getElementById('dog-name');
                    if (dogName) formData.dogName = dogName.value;
                    break;
                    
                case 'Q3':
                    const dogDesc = document.getElementById('dog-description');
                    if (dogDesc) formData.dogDescription = dogDesc.value;
                    break;
                    
                case 'contact':
                    const email = document.getElementById('contact-email');
                    const phone = document.getElementById('contact-phone');
                    if (email) formData.email = email.value;
                    if (phone) formData.phone = phone.value;
                    break;
            }
        }

        // Handle option selection
        function selectOption(element, value) {
            // Remove selected class from siblings
            element.parentNode.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Store the value
            formData[currentQuestion] = value;
            
            // Enable continue button
            const continueBtn = document.querySelector('.question-container.active .btn-primary');
            if (continueBtn) {
                continueBtn.disabled = false;
            }
        }

        // Skip text input
        function skipTextInput() {
            nextQuestion();
        }

        // Skip file upload
        function skipUpload() {
            nextQuestion();
        }

        // Check text input and enable/disable continue button
        function checkTextInput() {
            // For optional fields, always enable the continue button
            const continueBtn = document.querySelector('.question-container.active .btn-primary');
            if (continueBtn) {
                continueBtn.disabled = false;
            }
        }

        // Validate contact form
        function validateContactForm() {
            const email = document.getElementById('contact-email');
            const continueBtn = document.querySelector('.question-container.active .btn-primary');
            
            if (email && continueBtn) {
                // Enable button if email is valid
                const isValidEmail = email.value.trim() !== '' && email.checkValidity();
                continueBtn.disabled = !isValidEmail;
            }
        }

        // Validate contact info before proceeding
        function validateContact() {
            const email = document.getElementById('contact-email');
            
            if (email && email.value.trim() !== '' && email.checkValidity()) {
                saveCurrentQuestionData();
                submitForm();
            } else {
                alert('Please enter a valid email address.');
            }
        }

        // Submit the form
        function submitForm() {
            saveCurrentQuestionData();
            
            // Show completion screen
            showQuestion('complete');
            
            // Start image generation
            startImageGeneration();
        }

        // Start image generation
        async function startImageGeneration() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const imageResults = document.getElementById('imageResults');
            
            if (!loadingIndicator || !imageResults) return;
            
            // Show loading indicator
            loadingIndicator.classList.add('show');
            
            try {
                // Create detailed charm design prompt based ONLY on the photo
                let prompt = "";
                
                // If we have a photo, reference it directly for design
                if (formData.dogPhotoData) {
                    prompt += "Create a custom charm that exactly replicates the subject shown in the reference photo. ";
                } else {
                    prompt += "Create a custom charm design. ";
                }
                
                // Add material-specific details
                let materialType = "polished reflective sterling silver metal";
                let charmMetal = "silver";
                
                if (formData.materials) {
                    if (formData.materials === 'sterling-silver') {
                        materialType = "polished reflective sterling silver metal";
                        charmMetal = "silver";
                    } else if (formData.materials === '14k-gold') {
                        materialType = "polished reflective 14K gold metal";
                        charmMetal = "gold";
                    } else if (formData.materials === 'gold-plated') {
                        materialType = "polished reflective gold-plated metal";
                        charmMetal = "gold";
                    } else if (formData.materials === 'help-decide') {
                        materialType = "polished reflective sterling silver metal";
                        charmMetal = "silver";
                    }
                }
                
                // Structured prompt format
                prompt += `
                Subject: a ${charmMetal} charm that exactly matches the subject from the reference photo
                Style: high-gloss 3D sculptural metal
                Material: ${materialType}
                Lighting: studio lighting with soft reflections and minimal shadows
                Background: clean transparent background
                Presentation: floating product shot, charm angled to show volume and shine
                Detail: smooth, rounded surfaces with subtle contours, single integrated hook at top
                Camera: close-up, eye-level with a slight tilt
                Requirements: ENTIRE subject must be fully encapsulated within charm boundaries, complete silhouette capturing all key features, single hook (no jump rings), consistent metal finish throughout, EXACT replication of the subject's appearance, distinctive features, and proportions
                `;
                
                console.log('Generating ultra-shiny charm design with prompt:', prompt);
                
                // Generate image using OpenAI API with GPT Image model
                const imageUrl = await generateImage(prompt, formData.dogPhotoData);
                
                if (imageUrl) {
                    // Hide loading indicator
                    loadingIndicator.classList.remove('show');
                    
                    // Show generated image first (without story)
                    imageResults.innerHTML = `
                        <div class="image-container">
                            <h3 style="font-weight: 300;">Your Custom Charm Design</h3>
                            <img src="${imageUrl}" alt="Custom charm design" class="generated-image">
                            <div id="storyContainer" style="opacity: 0.5;">
                                <div style="text-align: center; padding: 10px; color: #666;">
                                    <div class="loading-spinner" style="display: inline-block; margin-right: 10px;">
                                        <svg version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300.000000 166.000000" preserveAspectRatio="xMidYMid meet" style="width: 20px; height: 20px;">
                                            <g transform="translate(0.000000,166.000000) scale(0.100000,-0.100000)" fill="#DAE0FF" stroke="none">
                                                <path d="M186 1478 c16 -222 84 -401 209 -547 25 -29 45 -56 43 -60 -2 -3 -29
                                                -50 -61 -104 -96 -161 -171 -366 -202 -554 l-7 -42 94 40 c126 55 255 127 363
                                                204 95 68 295 249 295 267 0 6 -17 25 -37 43 l-38 33 -90 -87 c-50 -47 -125
                                                -112 -168 -144 -87 -66 -246 -162 -254 -154 -10 11 40 143 95 250 30 60 81
                                                144 113 187 l58 79 -37 31 c-94 77 -189 226 -231 364 -31 102 -31 103 47 61
                                                144 -79 302 -225 501 -463 112 -134 297 -316 401 -393 367 -273 719 -319 1070
                                                -138 162 83 355 258 469 423 62 90 64 70 -28 200 -65 92 -200 232 -287 298
                                                -183 140 -353 200 -559 200 -285 -1 -579 -132 -823 -367 -106 -101 -105 -100
                                                -40 -146 l29 -21 92 89 c215 204 461 319 707 330 150 6 234 -11 365 -76 156
                                                -77 299 -201 416 -360 l47 -65 -31 -45 c-17 -25 -67 -84 -112 -130 -206 -215
                                                -424 -321 -660 -322 -333 -2 -639 196 -1026 661 -217 260 -428 424 -644 500
                                                -27 10 -58 21 -67 25 -15 6 -16 0 -12 -67z"/>
                                                <path d="M2194 1090 c-35 -14 -64 -59 -64 -99 0 -86 80 -141 154 -106 130 62
                                                44 259 -90 205z"/>
                                            </g>
                                        </svg>
                                    </div>
                                    Crafting your story...
                                </div>
                            </div>
                            <div class="button-group" style="margin-top: 20px; justify-content: center;">
                                <button class="btn-regenerate" onclick="restartQuiz()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; margin-right: 8px;">
                                        <polyline points="23 4 23 10 17 10"></polyline>
                                        <polyline points="1 20 1 14 7 14"></polyline>
                                        <path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                    Create Another Charm
                                </button>
                            </div>
                        </div>
                    `;
            
            // Now generate story content asynchronously
            generateStoryContent().then(storyContent => {
                const storyContainer = document.getElementById('storyContainer');
                if (storyContainer && storyContent) {
                    storyContainer.style.opacity = '1';
                    storyContainer.innerHTML = storyContent;
                } else if (storyContainer) {
                    storyContainer.style.display = 'none';
                }
            }).catch(error => {
                console.error('Error generating story:', error);
                const storyContainer = document.getElementById('storyContainer');
                if (storyContainer) {
                    storyContainer.style.display = 'none';
                }
            });
            
        } else {
            throw new Error('Failed to generate image');
        }
        
    } catch (error) {
        console.error('Image generation error:', error);
        
        // Hide loading indicator
        loadingIndicator.classList.remove('show');
        
        // Show fallback message
        imageResults.innerHTML = `
            <div class="image-container">
                <h3>Design Preview Coming Soon</h3>
                <p>We're preparing your custom ultra-shiny charm design and will send it to your email within 24-48 hours!</p>
                <p style="font-size: 14px; color: #666; margin-top: 10px;">Our designers will create a brilliant, mirror-polished charm that captures your subject's exact appearance.</p>
            </div>
        `;
    }
}

// Generate story content based on subject's name and description
async function generateStoryContent() {
    if (!formData.dogName && !formData.dogDescription) {
        return '';
    }
    
    try {
        // Determine the material for the story
        let materialDescription = "precious metal";
        if (formData.materials) {
            if (formData.materials === 'sterling-silver') {
                materialDescription = "sterling silver";
            } else if (formData.materials === '14k-gold') {
                materialDescription = "14K gold";
            } else if (formData.materials === 'gold-plated') {
                materialDescription = "gold";
            } else if (formData.materials === 'help-decide') {
                materialDescription = "sterling silver"; // Default for help-decide
            }
        }
        
        // Create a prompt for generating a poetic story
        let storyPrompt = `Write a beautiful, poetic, and heartwarming story about a custom charm made from ${materialDescription}. `;
        
        const subjectName = formData.dogName ? capitalizeFirstLetter(formData.dogName) : "your beloved subject";
        
        if (formData.dogName && formData.dogDescription) {
            storyPrompt += `The subject's name is ${subjectName} and they ${formData.dogDescription}. `;
        } else if (formData.dogName) {
            storyPrompt += `The subject's name is ${subjectName}. `;
        } else if (formData.dogDescription) {
            storyPrompt += `This special subject ${formData.dogDescription}. `;
        }
        
        storyPrompt += `Write 1-2 elegant sentences about how this custom ${materialDescription} charm captures their essence and will be a meaningful keepsake. Keep it simple, warm, and heartfelt.`;
        
        // Generate story using AI
        const aiStory = await generateStoryWithAI(storyPrompt);
        
        if (aiStory) {
            return `
                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border-left: 4px solid #6c757d;">
                    <h4 style="margin-bottom: 15px; color: #000; font-family: 'Avenir Next', sans-serif; font-weight: 500;">Your Story</h4>
                    <p style="font-size: 15px; line-height: 1.6; color: #333; font-family: 'Avenir Next', sans-serif; font-style: italic; margin: 0;">${aiStory}</p>
                </div>
            `;
        } else {
            // Fallback to original story if AI fails
            return generateFallbackStory(subjectName, materialDescription);
        }
        
    } catch (error) {
        console.error('Error generating AI story:', error);
        // Fallback to original story
        const subjectName = formData.dogName ? capitalizeFirstLetter(formData.dogName) : "your beloved subject";
        const materialDescription = formData.materials === '14k-gold' || formData.materials === 'gold-plated' ? 'gold' : 'sterling silver';
        return generateFallbackStory(subjectName, materialDescription);
    }
}

// Generate story using AI
async function generateStoryWithAI(prompt) {
    try {
        // Check if we have an API key
        let apiKey = null;
        
        if (window.CONFIG && window.CONFIG.OPENAI_API_KEY && window.CONFIG.OPENAI_API_KEY !== 'your-openai-api-key-here') {
            apiKey = window.CONFIG.OPENAI_API_KEY;
        } else {
            return null;
        }
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [{
                    role: "user",
                    content: prompt
                }],
                max_tokens: 150,
                temperature: 0.8
            })
        });
        
        if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content.trim();
        
    } catch (error) {
        console.error('Error calling OpenAI API for story:', error);
        return null;
    }
}

// Fallback story generation
function generateFallbackStory(subjectName, materialDescription = "precious metal") {
    let story = '<div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border-left: 4px solid #6c757d;">';
    story += '<h4 style="margin-bottom: 15px; color: #000; font-family: \'Avenir Next\', sans-serif; font-weight: 500;">Your Story</h4>';
    
    if (formData.dogName && formData.dogDescription) {
        story += `<p style="font-size: 15px; line-height: 1.6; color: #333; font-family: 'Avenir Next', sans-serif; font-style: italic; margin: 0;">This special ${materialDescription} charm celebrates ${subjectName}, who ${formData.dogDescription}. Every time you wear this charm, you'll carry a piece of ${subjectName}'s unique spirit with you.</p>`;
    } else if (formData.dogName) {
        story += `<p style="font-size: 15px; line-height: 1.6; color: #333; font-family: 'Avenir Next', sans-serif; font-style: italic; margin: 0;">This special ${materialDescription} charm celebrates ${subjectName}. Every time you wear this charm, you'll carry a piece of ${subjectName}'s unique spirit with you.</p>`;
    } else if (formData.dogDescription) {
        story += `<p style="font-size: 15px; line-height: 1.6; color: #333; font-family: 'Avenir Next', sans-serif; font-style: italic; margin: 0;">This special ${materialDescription} charm celebrates your beloved subject, who ${formData.dogDescription}. Every time you wear this charm, you'll carry a piece of their unique spirit with you.</p>`;
    }
    
    story += '</div>';
    return story;
}

// Capitalize first letter of a string
function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase();
}

// Generate image using OpenAI API with GPT Image model
async function generateImage(prompt, photoData = null) {
    try {
        console.log('Starting image generation with GPT Image...');
        console.log('Prompt:', prompt);
        
        // Check if we have an API key
        let apiKey = null;
        
        // Try to get API key from config
        if (window.CONFIG && window.CONFIG.OPENAI_API_KEY && window.CONFIG.OPENAI_API_KEY !== 'your-openai-api-key-here') {
            apiKey = window.CONFIG.OPENAI_API_KEY;
            console.log('API key found in window.CONFIG');
        } else {
            console.log('No valid API key found in window.CONFIG');
            console.log('window.CONFIG:', window.CONFIG);
        }
        
        if (!apiKey) {
            console.error('No OpenAI API key available');
            throw new Error('OpenAI API key not configured');
        }
        
        console.log('Making API request to OpenAI Responses API...');
        
        // Prepare the input content
        let inputContent = [];
        
        // Add the text prompt
        inputContent.push({
            type: "input_text",
            text: prompt
        });
        
        // Add the photo if available
        if (photoData) {
            console.log('Including photo as reference');
            inputContent.push({
                type: "input_image",
                image_url: photoData
            });
        }
        
        const requestBody = {
            model: "gpt-4.1-mini",
            input: [{
                role: "user",
                content: inputContent
            }],
            tools: [{
                type: "image_generation",
                quality: "high",
                size: "1024x1024",
                background: "transparent"
            }]
        };
        
        const response = await fetch('https://api.openai.com/v1/responses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify(requestBody)
        });
        
        console.log('API response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API error response:', errorText);
            throw new Error(`API request failed: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log('API response data:', data);
        
        // Extract image data from the response
        const imageGenerationCalls = data.output?.filter(output => output.type === "image_generation_call");
        
        if (imageGenerationCalls && imageGenerationCalls.length > 0 && imageGenerationCalls[0].result) {
            const imageBase64 = imageGenerationCalls[0].result;
            console.log('Image generated successfully');
            
            // Convert base64 to data URL for display
            const imageDataUrl = `data:image/png;base64,${imageBase64}`;
            return imageDataUrl;
        } else {
            throw new Error('Invalid response format from OpenAI API');
        }
        
    } catch (error) {
        console.error('Error generating image:', error);
        throw error; // Re-throw to be handled by caller
    }
}

// Restart quiz from the beginning
function restartQuiz() {
    console.log('Restarting quiz...');
    
    // Clear all form data
    formData = {};
    
    // Reset quiz state
    currentQuestion = 'Q1';
    currentQuestionIndex = 0;
    questionHistory = [];
    
    // Clear all form inputs
    const dogNameInput = document.getElementById('dog-name');
    if (dogNameInput) dogNameInput.value = '';
    
    const dogDescInput = document.getElementById('dog-description');
    if (dogDescInput) dogDescInput.value = '';
    
    const emailInput = document.getElementById('contact-email');
    if (emailInput) emailInput.value = '';
    
    const phoneInput = document.getElementById('contact-phone');
    if (phoneInput) phoneInput.value = '';
    
    // Clear file upload
    const fileInput = document.getElementById('dog-photo');
    if (fileInput) fileInput.value = '';
    
    const fileInfo = document.getElementById('dog-photo-info');
    if (fileInfo) {
        fileInfo.innerHTML = '';
        fileInfo.classList.remove('show');
    }
    
    // Clear all selected options
    document.querySelectorAll('.option.selected').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Reset all continue buttons to enabled state for Q1, disabled for others
    document.querySelectorAll('.btn-primary').forEach(btn => {
        btn.disabled = false; // Enable all buttons initially
    });
    
    // Specifically disable buttons that should start disabled
    const materialsBtn = document.querySelector('[data-question="materials"] .btn-primary');
    if (materialsBtn) materialsBtn.disabled = true;
    
    const contactBtn = document.querySelector('[data-question="contact"] .btn-primary');
    if (contactBtn) contactBtn.disabled = true;
    
    // Reset container to normal mode
    const container = document.querySelector('.container');
    if (container) {
        container.classList.remove('results-mode');
    }
    
    // Clear any loading indicators
    const loadingIndicator = document.getElementById('loadingIndicator');
    if (loadingIndicator) {
        loadingIndicator.classList.remove('show');
    }
    
    // Clear image results
    const imageResults = document.getElementById('imageResults');
    if (imageResults) {
        imageResults.innerHTML = '';
    }
    
    console.log('Quiz reset complete. Showing Q1...');
    
    // Show first question
    showQuestion('Q1');
    updateProgress();
    
    console.log('Current question after restart:', currentQuestion);
    console.log('Current question index after restart:', currentQuestionIndex);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeQuiz();
});
</script>
</body>
</html>