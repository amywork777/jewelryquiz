<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Custom Charm Design Questionnaire</title>
    <script src="config.js"></script>
    <script>
        // Debug: Check if config loaded immediately
        console.log('Config check after script load:');
        console.log('window.CONFIG:', window.CONFIG);
        console.log('window.OPENAI_API_KEY:', window.OPENAI_API_KEY);
        
        // Also check after a short delay in case it's async
        setTimeout(() => {
            console.log('Config check after 1 second:');
            console.log('window.CONFIG:', window.CONFIG);
            console.log('window.OPENAI_API_KEY:', window.OPENAI_API_KEY);
        }, 1000);
    </script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Avenir Next', 'Avenir', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 300;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            /* Iframe optimizations */
            overflow-x: auto;
            overflow-y: auto;
        }

        /* Iframe-specific optimizations */
        @media (max-width: 1200px) {
            body {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }
        }

        @media (max-width: 900px) {
            body {
                padding: 5px;
                padding-top: 10px;
            }
        }

        .container {
            background: white;
            border: 1px solid #000000;
            box-shadow: 0 0 0 1px #000000;
            max-width: 600px;
            width: 100%;
            padding: 40px;
            position: relative;
            overflow: hidden;
            transition: max-width 0.5s ease;
            /* Iframe optimizations */
            min-width: 320px;
            box-sizing: border-box;
        }

        .container.results-mode {
            max-width: 1450px; /* Increased to accommodate wider ecommerce layout */
        }

        /* Container responsive optimizations */
        @media (max-width: 1500px) {
            .container.results-mode {
                max-width: 95vw;
            }
        }

        @media (max-width: 1200px) {
            .container {
                padding: 30px;
            }
            .container.results-mode {
                max-width: 98vw;
            }
        }

        @media (max-width: 900px) {
            .container {
                padding: 20px;
                border: none;
                box-shadow: none;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
                margin: 0;
            }
        }

        @media (max-width: 400px) {
            .container {
                padding: 10px;
            }
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #f0f0f0;
        }

        .progress-fill {
            height: 100%;
            background: #000000;
            width: 0%;
            transition: width 0.5s ease;
        }

        .question-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .question-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #000000;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 300;
            letter-spacing: -0.5px;
        }

        h2 {
            color: #000000;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 300;
            letter-spacing: -0.3px;
        }

        p {
            color: #000000;
            margin-bottom: 30px;
            font-size: 18px;
            line-height: 1.6;
            font-weight: 300;
        }

        /* Typography responsive optimizations */
        @media (max-width: 900px) {
            h1 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            
            h2 {
                font-size: 20px;
                margin-bottom: 20px;
            }
            
            p {
                font-size: 16px;
                margin-bottom: 20px;
                line-height: 1.5;
            }
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 22px;
            }
            
            h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            p {
                font-size: 15px;
                margin-bottom: 15px;
            }
        }

        @media (max-width: 400px) {
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            p {
                font-size: 14px;
                margin-bottom: 12px;
            }
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .option {
            padding: 20px;
            border: 1px solid #000000;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            text-align: left;
            background: #ffffff;
            font-weight: 300;
            position: relative;
        }

        .option-with-image {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
        }

        .option-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
        }

        .option::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: #DAE0FF;
            transition: width 0.3s ease;
            z-index: -1;
        }

        .option:hover::after {
            width: 100%;
        }

        .option:hover {
            transform: translateX(5px);
        }

        .option:hover {
            transform: translateX(5px);
        }

        .option.selected {
            background: #DAE0FF;
            border: 2px solid #000000;
            padding: 19px;
            animation: selectPulse 0.3s ease;
        }

        @keyframes selectPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .multi-select .option.selected {
            background: #000000;
            color: #ffffff;
            border: 1px solid #000000;
            padding: 20px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #000000;
            font-size: 16px;
            transition: border-color 0.3s ease;
            font-family: inherit;
            background: #ffffff;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        textarea:focus {
            outline: none;
            border: 2px solid #000000;
            padding: 14px;
            background: #DAE0FF;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
        }

        .file-upload input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: block;
            padding: 40px 20px;
            border: 3px dashed #000000;
            text-align: center;
            color: #000000;
            transition: all 0.3s ease;
            background: #ffffff;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 400;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .file-upload-label::before {
            content: "( ^ _ ^ )";
            font-size: 24px;
            display: block;
            margin-bottom: 8px;
            font-family: monospace;
        }

        .file-upload:hover .file-upload-label {
            background: #DAE0FF;
            border-color: #000000;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .file-upload-label.drag-over {
            background: #DAE0FF !important;
            border-color: #000000 !important;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .file-upload.drag-active {
            background: rgba(218, 224, 255, 0.1);
            border-radius: 8px;
        }

        .file-upload-instructions {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-weight: 300;
        }

        .file-info {
            margin-top: 10px;
            color: #000000;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        button {
            padding: 12px 20px;
            border: 1px solid #cccccc;
            font-size: 16px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 0 0 auto;
            background: #ffffff;
            color: #666666;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            max-width: 60px;
        }

        button svg {
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }

        button:hover svg {
            transform: translateX(3px);
        }

        .btn-secondary:hover svg {
            transform: translateX(-3px);
        }

        .btn-primary {
            background: #f8f8f8;
            color: #333333;
            border: 1px solid #dddddd;
        }

        .btn-primary:hover {
            background: #DAE0FF;
            color: #000000;
            border: 1px solid #000000;
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #f5f5f5;
            color: #cccccc;
            border: 1px solid #eeeeee;
        }

        .btn-secondary {
            background: #ffffff;
            color: #666666;
            border: 1px solid #dddddd;
        }

        .btn-secondary:hover {
            background: #f0f0f0;
            color: #333333;
            border: 1px solid #999999;
        }

        .skip-link {
            text-align: center;
            margin-top: 15px;
            color: #000000;
            font-size: 14px;
        }

        .skip-link a {
            color: #000000;
            text-decoration: underline;
        }

        .skip-link a:hover {
            background: #DAE0FF;
            text-decoration: none;
        }

        .results {
            background: #DAE0FF;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid #000000;
        }

        .results h3 {
            color: #000000;
            margin-bottom: 20px;
        }

        .results-list {
            list-style: none;
        }

        .results-list li {
            padding: 10px 0;
            border-bottom: 1px solid #000000;
        }

        .results-list li:last-child {
            border-bottom: none;
        }

        .results-list strong {
            color: #000000;
            display: inline-block;
            min-width: 150px;
        }

        .completion-message {
            text-align: center;
            padding: 40px;
        }

        .completion-message h1 {
            color: #000000;
            margin-bottom: 20px;
        }

        .completion-message p {
            font-size: 20px;
            color: #000000;
        }



        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            p {
                font-size: 16px;
            }

            .option {
                padding: 15px;
                font-size: 15px;
            }
        }

        /* Design layout styles */
        .design-container {
            display: flex !important;
            gap: 20px !important;
            margin-bottom: 20px !important;
            flex-wrap: nowrap !important;
            overflow-x: auto !important;
            justify-content: center !important;
            align-items: flex-start !important;
        }

        .design-item {
            flex: 1 1 45% !important;
            min-width: 300px !important;
            max-width: 400px !important;
            padding: 15px !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 8px !important;
            text-align: center !important;
            background: #ffffff !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }

        .design-item h5 {
            margin: 0 0 15px 0 !important;
            color: #000 !important;
            font-size: 16px !important;
            font-weight: 500 !important;
            padding-bottom: 10px !important;
            border-bottom: 1px solid #f0f0f0 !important;
        }

        /* Ensure exactly 2 designs are shown side by side */
        .design-container .design-item:nth-child(n+3) {
            display: none !important;
        }

        /* Design image styling */
        .design-item img {
            width: 100% !important;
            max-width: 280px !important;
            height: auto !important;
            border-radius: 6px !important;
            margin-bottom: 15px !important;
            border: 1px solid #f0f0f0 !important;
        }

        /* Purchase section styles */
        .material-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #000 !important;
        }

        .material-option.premium:hover {
            border-color: #f39c12 !important;
            box-shadow: 0 4px 12px rgba(244, 208, 63, 0.3);
        }

        .material-option button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .material-option.premium button:hover {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%) !important;
        }

        @media (max-width: 768px) {
            .design-item {
                min-width: 250px !important;
                padding: 12px !important;
            }
            
            .design-item h5 {
                font-size: 15px !important;
                margin-bottom: 12px !important;
            }
        }

        @media (max-width: 640px) {
            .design-container {
                flex-direction: column !important;
                overflow-x: visible !important;
                gap: 15px !important;
            }
            
            .design-item {
                flex: none !important;
                min-width: auto !important;
                max-width: none !important;
                width: 100% !important;
                margin: 0 auto !important;
            }

            .design-item img {
                max-width: 220px !important;
            }

            /* Mobile purchase section */
            .material-option {
                min-width: auto !important;
                max-width: none !important;
                margin-bottom: 15px;
            }
        }

        /* Mobile responsive for 3-column layout */
        @media (max-width: 768px) {
            .three-column-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            
            .three-column-grid > div {
                border-right: none !important;
                border-bottom: 1px solid #e0e0e0;
                padding-bottom: 20px !important;
            }
            
            .three-column-grid > div:last-child {
                border-bottom: none !important;
            }
        }

        /* Mobile optimization for purchase section */
        @media (max-width: 640px) {
            .container.results-mode {
                max-width: 100% !important;
                padding: 15px !important;
            }
            
            .design-container {
                gap: 20px !important;
            }
            
            .design-item {
                padding: 15px !important;
                min-width: auto !important;
            }
            
            /* Mobile purchase section optimization */
            .mobile-purchase-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .mobile-purchase-grid label {
                padding: 10px !important;
                font-size: 13px !important;
            }
            
            /* Adjust main purchase section on mobile */
            #main-buy-button {
                padding: 12px 16px !important;
                font-size: 14px !important;
            }
            
            /* Mobile spacing adjustments */
            .container.results-mode h4 {
                text-align: center !important;
            }
            
                         /* Smaller text and spacing on mobile */
             h4 {
                 font-size: 18px !important;
                 margin: 20px 0 12px 0 !important;
             }
             
             .story-section {
                 padding: 12px !important;
                 margin: 10px 0 !important;
             }
             
             .feedback-section {
                 margin-top: 8px !important;
             }
             
             .feedback-section button {
                 padding: 10px 12px !important;
                 font-size: 13px !important;
             }
             
             /* Hide story section on mobile to reduce clutter */
             .story-section {
                 display: none !important;
             }
         }

        /* Swimming Fish Animation for Loading */
        .swimming-logo-container {
            position: relative;
            width: 100%;
            height: 40px;
            overflow: hidden;
            margin: 3px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .swimming-logo {
            position: absolute;
            height: 30px;
            width: auto;
            animation: fishSwim 8s linear infinite;
            transform-origin: center;
            will-change: transform, opacity;
        }
        
        @keyframes fishSwim {
            /* Start centered, fully visible */
            0% {
                transform: translateX(0%) translateY(0px) rotate(0deg);
                opacity: 1;
            }
            
            /* Swimming right with slight wave motion */
            15% {
                transform: translateX(50%) translateY(2px) rotate(1deg);
                opacity: 1;
            }
            
            30% {
                transform: translateX(100%) translateY(-2px) rotate(-1deg);
                opacity: 1;
            }
            
            /* Start fading out as it approaches right edge */
            40% {
                transform: translateX(150%) translateY(1px) rotate(1deg);
                opacity: 0.8;
            }
            
            /* Completely fade out before the position reset */
            49% {
                transform: translateX(200%) translateY(0px) rotate(0deg);
                opacity: 0;
            }
            
            /* Instantly move to far left while invisible */
            51% {
                transform: translateX(-200%) translateY(0px) rotate(0deg);
                opacity: 0;
            }
            
            /* Start fading in from left side */
            60% {
                transform: translateX(-150%) translateY(-1px) rotate(-1deg);
                opacity: 0.8;
            }
            
            /* Fully visible again */
            70% {
                transform: translateX(-100%) translateY(2px) rotate(1deg);
                opacity: 1;
            }
            
            85% {
                transform: translateX(-50%) translateY(-2px) rotate(-1deg);
                opacity: 1;
            }
            
            /* Back to center, fully visible */
            100% {
                transform: translateX(0%) translateY(0px) rotate(0deg);
                opacity: 1;
            }
        }

        /* Mobile font weight improvements */
        @media (max-width: 640px) {
            body {
                font-weight: 400; /* Increase from 300 to 400 on mobile */
            }
            
            h1, h2 {
                font-weight: 400; /* Increase from 300 to 400 on mobile */
            }
            
            p {
                font-weight: 400; /* Increase from 300 to 400 on mobile */
            }
            
            .option {
                font-weight: 400; /* Increase from 300 to 400 on mobile */
            }
            
            input[type="text"],
            input[type="email"],
            input[type="tel"],
            textarea {
                font-weight: 400; /* Increase font weight on mobile */
            }
        }

        /* Ecommerce-style results layout */
        .results-ecommerce {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
            max-width: 1200px;
            width: 100%;
        }

        .product-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .product-image-container {
            position: relative;
            background: #f8f9fa;
            padding: 40px 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-image {
            max-width: 100%;
            max-height: 280px;
            width: auto;
            height: auto;
            border-radius: 8px;
            object-fit: contain;
            background: transparent;
            border: none;
            outline: none;
            margin: 0;
            padding: 0;
        }

        .product-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #000000;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-info {
            padding: 25px;
        }

        .product-title {
            font-size: 20px;
            font-weight: 500;
            color: #000000;
            margin: 0 0 8px 0;
            letter-spacing: -0.3px;
        }

        .product-subtitle {
            font-size: 14px;
            color: #666666;
            margin: 0 0 20px 0;
            font-weight: 400;
        }

        .product-story {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid #DAE0FF;
        }

        .product-story h6 {
            margin: 0 0 8px 0;
            color: #000000;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-story p {
            margin: 0;
            color: #333333;
            font-size: 14px;
            line-height: 1.5;
            font-style: italic;
            font-weight: 400;
        }

        .product-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .product-select-btn {
            width: 100%;
            padding: 15px 20px;
            background: #ffffff;
            border: 2px solid #e0e0e0;
            color: #666666;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-select-btn:hover {
            border-color: #000000;
            background: #f8f9fa;
            color: #000000;
        }

        .product-select-btn.selected {
            background: #000000;
            color: #ffffff;
            border-color: #000000;
        }

        .product-refine-btn {
            width: 100%;
            padding: 12px 20px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            color: #666666;
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
        }

        .product-refine-btn:hover {
            background: #e9ecef;
            color: #333333;
        }

        /* Mobile responsive for ecommerce layout */
        @media (max-width: 768px) {
            .results-ecommerce {
                grid-template-columns: 1fr;
                gap: 20px;
                margin: 20px 0;
            }
            
            .product-image-container {
                padding: 30px 15px;
                min-height: 250px;
            }
            
            .product-image {
                max-height: 220px;
            }
            
            .product-info {
                padding: 20px;
            }
            
            .product-title {
                font-size: 18px;
            }
        }

        /* Purchase section improvements */
        .purchase-section-ecommerce {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .purchase-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .purchase-title {
            font-size: 24px;
            font-weight: 500;
            color: #000000;
            margin: 0 0 8px 0;
        }

        .purchase-subtitle {
            font-size: 14px;
            color: #666666;
            margin: 0;
        }

        .material-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .material-option-ecommerce {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .material-option-ecommerce:hover {
            border-color: #000000;
            background: #f8f9fa;
        }

        .material-option-ecommerce.selected {
            border-color: #000000;
            background: #DAE0FF;
        }

        .material-name {
            font-size: 14px;
            font-weight: 500;
            color: #000000;
            margin: 0 0 4px 0;
        }

        .material-price {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
        }

        @media (max-width: 640px) {
            .material-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .purchase-section-ecommerce {
                padding: 20px;
                margin: 20px 0;
            }
            
            .purchase-title {
                font-size: 20px;
            }
        }

        /* Classic ecommerce layout */
        .ecommerce-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            margin: 30px 0;
            max-width: 1400px; /* Increased from 1200px */
            width: 100%;
        }

        .product-images-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .product-image-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px; /* Increased gap */
        }

        .product-image-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }

        .product-image-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .product-image-card.selected {
            border: 2px solid #000000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .image-container {
            position: relative;
            background: transparent;
            padding: 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: none;
        }

        .product-image {
            max-width: 100%;
            max-height: 280px; /* Increased size */
            width: auto;
            height: auto;
            border-radius: 8px;
            object-fit: contain;
            background: transparent;
            border: none;
            outline: none;
            margin: 0;
            padding: 0;
        }

        .image-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: #000000;
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .image-info {
            padding: 25px; /* Increased padding */
            text-align: center;
        }

        .image-title {
            font-size: 18px; /* Increased font size */
            font-weight: 500;
            color: #000000;
            margin: 0 0 8px 0;
        }

        .image-subtitle {
            font-size: 14px; /* Increased font size */
            color: #666666;
            margin: 0 0 15px 0;
        }

        .design-story-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid #DAE0FF;
            text-align: left;
        }

        .design-story-section h6 {
            margin: 0 0 10px 0;
            color: #000000;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .design-story-section p {
            margin: 0;
            color: #333333;
            font-size: 14px;
            line-height: 1.5;
            font-style: italic;
            font-weight: 400;
        }

        .select-image-text {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            color: #333333;
        }

        .select-image-text:hover {
            color: #000000;
        }

        .select-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #dddddd;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .select-image-text:hover .select-checkbox {
            border-color: #000000;
        }

        .select-image-text.selected .select-checkbox {
            background: #000000;
            border-color: #000000;
        }

        .select-image-text.selected {
            color: #000000;
            font-weight: 600;
        }

        .checkbox-check {
            color: #ffffff;
            font-size: 12px;
            font-weight: bold;
        }

        .purchase-sidebar {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            height: fit-content;
            position: sticky;
            top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        .purchase-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .purchase-title {
            font-size: 22px;
            font-weight: 500;
            color: #000000;
            margin: 0 0 8px 0;
        }

        .purchase-subtitle {
            font-size: 13px;
            color: #666666;
            margin: 0;
        }

        .selection-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .selection-status.has-selection {
            background: #e8f5e8;
            border: 1px solid #28a745;
        }

        .material-section {
            margin-bottom: 25px;
        }

        .section-label {
            font-size: 14px;
            font-weight: 500;
            color: #000000;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Material Dropdown Styling */
        .material-dropdown {
            position: relative;
            width: 100%;
        }

        .material-select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #ffffff;
            font-size: 14px;
            font-weight: 500;
            color: #000000;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 45px;
        }

        .material-select:hover {
            border-color: #000000;
            background-color: #f8f9fa;
        }

        .material-select:focus {
            outline: none;
            border-color: #000000;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .material-select option {
            padding: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Remove old material grid styles */
        .material-grid {
            display: none;
        }

        .material-option {
            display: none;
        }

        .price-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .price-details {
            flex: 1;
        }

        .price-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }

        .price-amount {
            font-size: 28px;
            font-weight: 600;
            color: #000000;
        }

        .shipping-info {
            text-align: right;
            font-size: 13px;
            color: #666;
        }

        .buy-button {
            width: 100%;
            padding: 18px 32px;
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: #ffffff;
            border: none;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-radius: 12px;
            margin: 0 auto 15px auto;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15), 0 3px 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            align-self: stretch;
            line-height: 1;
            vertical-align: middle;
        }

        /* Desktop-specific buy button styling for better appearance */
        @media (min-width: 769px) {
            .buy-button {
                padding: 22px 60px;
                font-size: 16px;
                letter-spacing: 2px;
                min-width: 280px;
                max-width: 400px;
                margin: 20px auto;
            }
        }

        .buy-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s;
        }

        .buy-button:hover::before {
            left: 100%;
        }

        .buy-button:hover {
            background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.25), 0 6px 15px rgba(0,0,0,0.15);
        }

        .buy-button:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2), 0 2px 8px rgba(0,0,0,0.1);
        }

        .buy-button:disabled {
            background: #f8f8f8;
            color: #999999;
            border: 1px solid #dddddd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Checkout button responsive optimizations */
        @media (max-width: 900px) {
            .buy-button {
                padding: 16px 28px;
                font-size: 14px;
                letter-spacing: 1.2px;
            }
        }

        @media (max-width: 600px) {
            .buy-button {
                padding: 14px 24px;
                font-size: 13px;
                letter-spacing: 1px;
                border-radius: 10px;
            }
        }

        @media (max-width: 400px) {
            .buy-button {
                padding: 12px 20px;
                font-size: 12px;
                letter-spacing: 0.8px;
                border-radius: 8px;
            }
        }

        .checkout-disabled-text {
            text-align: center;
            color: #333333;
            font-size: 16px;
            font-weight: 500;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .trust-signals {
            text-align: center;
            font-size: 12px;
            color: #666;
            line-height: 1.4;
            margin-top: auto;
        }

        /* Design summary section - moved to bottom */
        .design-summary-section {
            margin-top: 50px;
            padding: 30px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            max-width: 1400px;
            width: 100%;
        }

        .design-summary-section h3 {
            font-size: 22px;
            font-weight: 500;
            color: #000000;
            margin: 0 0 25px 0;
            text-align: center;
        }

        .summary-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            background: #ffffff;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 500;
            color: #000000;
            font-size: 14px;
        }

        .summary-value {
            color: #666666;
            font-size: 14px;
            text-align: right;
        }

        .refine-section {
            margin-top: 15px;
        }

        .refine-toggle {
            padding: 8px 0;
            background: none;
            border: none;
            color: #666666;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .refine-toggle:hover {
            color: #000000;
        }

        .refine-content {
            display: none;
            margin-top: 12px;
        }

        .refine-textarea {
            width: 100%;
            height: 60px;
            padding: 10px;
            border: 1px solid #e9ecef;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 10px;
            background: #ffffff;
            border-radius: 4px;
        }

        .refine-button {
            width: 100%;
            padding: 10px 15px;
            background: #f8f8f8;
            color: #333333;
            border: 1px solid #dddddd;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            border-radius: 6px;
        }

        .refine-button:hover {
            background: #DAE0FF;
            color: #000000;
            border: 1px solid #000000;
        }

        /* Enhanced responsive design for iframe compatibility */
        @media (max-width: 1400px) {
            .ecommerce-layout {
                gap: 15px;
            }
            
            .purchase-sidebar {
                padding: 25px;
            }
        }

        @media (max-width: 1200px) {
            .ecommerce-layout {
                grid-template-columns: 1fr;
                gap: 20px;
                max-width: 100%;
            }
            
            .purchase-sidebar {
                position: static;
                order: -1;
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .product-image-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 15px;
            }
        }

        @media (max-width: 900px) {
            .product-image-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .image-container {
                min-height: 250px;
                padding: 15px;
            }
            
            .product-image {
                max-height: 220px;
            }
        }

        @media (max-width: 768px) {
            .ecommerce-layout {
                gap: 15px;
            }
            
            .purchase-sidebar {
                padding: 15px;
            }
            
            .image-container {
                min-height: 200px;
                padding: 15px 10px;
            }
            
            .product-image {
                max-height: 180px;
            }

            .design-summary-section {
                margin-top: 20px;
                padding: 15px;
            }

            .summary-details {
                grid-template-columns: 1fr;
                padding: 15px;
                gap: 15px;
            }
        }

        @media (max-width: 600px) {
            .purchase-sidebar {
                padding: 10px;
            }
            
            .image-container {
                min-height: 180px;
                padding: 10px;
            }
            
            .product-image {
                max-height: 160px;
            }
        }

        @media (max-width: 400px) {
            .ecommerce-layout {
                gap: 10px;
            }
            
            .image-container {
                min-height: 150px;
                padding: 8px;
            }
            
            .product-image {
                max-height: 140px;
            }
        }

        /* Enhanced Mobile Optimizations for Better UX */
        @media (max-width: 768px) {
            /* Mobile-first ecommerce layout - stack vertically */
            .results-ecommerce {
                grid-template-columns: 1fr;
                gap: 15px;
                margin: 15px 0;
            }
            
            /* Wider product cards on mobile for better content display */
            .product-card {
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.06);
                width: 100%;
                max-width: none;
            }
            
            .product-image-container {
                padding: 20px 15px;
                min-height: 200px;
            }
            
            .product-image {
                max-height: 180px;
            }
            
            .product-info {
                padding: 15px;
            }
            
            .product-title {
                font-size: 16px;
                margin-bottom: 6px;
            }
            
            .product-subtitle {
                font-size: 13px;
                margin-bottom: 12px;
            }
            
            /* Full-width story section on mobile - purple section takes full width */
            .product-story {
                padding: 15px 20px; /* Increased horizontal padding */
                margin: 15px -25px; /* Larger negative margin to extend beyond container */
                border-radius: 0; /* Remove border radius for full width effect */
                border-left: none;
                border-left: 4px solid #DAE0FF; /* Thicker left border for emphasis */
                background: #DAE0FF; /* Make it more prominent */
            }
            
            .product-story h6 {
                font-size: 11px;
                margin-bottom: 6px;
                color: #000000;
                font-weight: 600;
            }
            
            .product-story p {
                font-size: 13px;
                line-height: 1.4;
                color: #333333;
                font-weight: 500;
            }
            
            /* Compact action buttons */
            .product-actions {
                gap: 8px;
                margin-top: 15px;
            }
            
            .product-select-btn {
                padding: 12px 16px;
                font-size: 13px;
                border-radius: 6px;
            }
            
            .product-refine-btn {
                padding: 10px 16px;
                font-size: 12px;
            }
        }

        /* Mobile Purchase Sidebar Optimizations */
        @media (max-width: 1200px) {
            .ecommerce-layout {
                grid-template-columns: 1fr;
                gap: 15px;
                max-width: 100%;
            }
            
            /* Move purchase sidebar to top on mobile for better UX */
            .purchase-sidebar {
                position: static;
                order: -1;
                padding: 20px;
                margin-bottom: 15px;
                border-radius: 8px;
            }
            
            /* Compact purchase header */
            .purchase-header {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
            
            .purchase-title {
                font-size: 20px;
                margin-bottom: 6px;
            }
            
            .purchase-subtitle {
                font-size: 12px;
            }
            
            /* Compact story section in sidebar */
            .design-story-section {
                padding: 12px !important;
                margin-bottom: 15px !important;
                border-radius: 6px !important;
            }
            
            .design-story-section h6 {
                font-size: 11px !important;
                margin-bottom: 6px !important;
            }
            
            .design-story-section p {
                font-size: 13px !important;
                line-height: 1.4 !important;
            }
            
            /* Compact selection status */
            .selection-status {
                padding: 12px;
                margin-bottom: 15px;
                border-radius: 6px;
                font-size: 13px;
            }
            
            /* Compact material section */
            .material-section {
                margin-bottom: 20px;
            }
            
            .section-label {
                font-size: 13px;
                margin-bottom: 10px;
            }
            
            /* Mobile dropdown styling */
            .material-select {
                padding: 12px 16px;
                font-size: 13px;
                border-radius: 6px;
                padding-right: 40px;
                background-size: 14px;
                background-position: right 12px center;
            }
            
            .material-select:hover {
                border-color: #000000;
            }
            
            .material-select:focus {
                box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
            }
            
            .material-name {
                font-size: 13px;
                margin-bottom: 3px;
            }
            
            .material-price {
                font-size: 15px;
            }
            
            /* Compact price summary */
            .price-summary {
                margin: 20px 0;
                padding: 15px;
                border-radius: 6px;
            }
            
            .price-label {
                font-size: 13px;
            }
            
            .price-amount {
                font-size: 24px;
            }
            
            .shipping-info {
                font-size: 12px;
            }
            
            /* Compact buy button */
            .buy-button {
                padding: 15px 28px;
                font-size: 14px;
                letter-spacing: 1.2px;
                margin-bottom: 12px;
                border-radius: 8px;
            }
            
            .checkout-disabled-text {
                padding: 15px;
                margin-bottom: 12px;
                font-size: 15px;
                border-radius: 6px;
            }
            
            .trust-signals {
                font-size: 11px;
                line-height: 1.3;
            }
        }

        /* Extra Mobile Optimizations for Small Screens */
        @media (max-width: 640px) {
            .container.results-mode {
                padding: 10px !important;
            }
            
            /* Ultra-compact product cards */
            .product-image-container {
                padding: 15px 10px;
                min-height: 160px;
            }
            
            .product-image {
                max-height: 140px;
            }
            
            .product-info {
                padding: 12px;
            }
            
            .product-title {
                font-size: 15px;
            }
            
            .product-subtitle {
                font-size: 12px;
                margin-bottom: 10px;
            }
            
            /* Hide story section on very small screens to save space */
            .product-story {
                display: none;
            }
            
            /* Ultra-compact purchase sidebar */
            .purchase-sidebar {
                padding: 15px;
            }
            
            .purchase-title {
                font-size: 18px;
            }
            
            .design-story-section {
                padding: 10px !important;
                margin-bottom: 12px !important;
            }
            
            .design-story-section h6 {
                font-size: 10px !important;
            }
            
            .design-story-section p {
                font-size: 12px !important;
            }
            
            .selection-status {
                padding: 10px;
                margin-bottom: 12px;
                font-size: 12px;
            }
            
            /* Ultra-compact dropdown for small screens */
            .material-select {
                padding: 10px 14px;
                font-size: 12px;
                padding-right: 35px;
                background-size: 12px;
                background-position: right 10px center;
            }
            
            .material-option {
                padding: 10px;
            }
            
            .material-name {
                font-size: 12px;
            }
            
            .material-price {
                font-size: 14px;
            }
            
            .price-summary {
                margin: 15px 0;
                padding: 12px;
            }
            
            .price-amount {
                font-size: 22px;
            }
            
            .buy-button {
                padding: 12px 24px;
                font-size: 13px;
                letter-spacing: 1px;
            }
            
            .checkout-disabled-text {
                padding: 12px;
                font-size: 14px;
            }
            
            /* Compact design summary */
            .design-summary-section {
                margin-top: 15px;
                padding: 12px;
            }
            
            .design-summary-section h3 {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            .summary-details {
                padding: 12px;
                gap: 12px;
            }
            
            .summary-item {
                padding: 8px 0;
            }
            
            .summary-label,
            .summary-value {
                font-size: 13px;
            }
        }

        /* Tiny Mobile Screens - Maximum Compactness */
        @media (max-width: 480px) {
            .container.results-mode {
                padding: 8px !important;
            }
            
            .ecommerce-layout {
                gap: 10px;
            }
            
            .product-image-container {
                padding: 12px 8px;
                min-height: 140px;
            }
            
            .product-image {
                max-height: 120px;
            }
            
            .product-info {
                padding: 10px;
            }
            
            .product-actions {
                gap: 6px;
                margin-top: 10px;
            }
            
            .product-select-btn {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .purchase-sidebar {
                padding: 12px;
            }
            
            .purchase-header {
                margin-bottom: 15px;
                padding-bottom: 12px;
            }
            
            .purchase-title {
                font-size: 16px;
            }
            
            .purchase-subtitle {
                font-size: 11px;
            }
            
            .material-grid {
                gap: 8px;
            }
            
            /* Maximum compact dropdown for tiny screens */
            .material-select {
                padding: 8px 12px;
                font-size: 11px;
                padding-right: 30px;
                background-size: 10px;
                background-position: right 8px center;
            }
            
            .material-option {
                padding: 8px;
            }
            
            .price-summary {
                margin: 12px 0;
                padding: 10px;
            }
            
            .price-amount {
                font-size: 20px;
            }
            
            .buy-button {
                padding: 10px 20px;
                font-size: 12px;
                letter-spacing: 0.8px;
                border-radius: 6px;
            }
            
            .trust-signals {
                font-size: 10px;
            }
            
            .design-summary-section {
                margin-top: 12px;
                padding: 10px;
            }
            
            .design-summary-section h3 {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            .summary-details {
                padding: 10px;
                gap: 10px;
            }
        }

        /* Mobile Questionnaire Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 22px;
                margin-bottom: 6px;
            }
            
            h2 {
                font-size: 18px;
                margin-bottom: 15px;
                line-height: 1.3;
            }
            
            p {
                font-size: 15px;
                margin-bottom: 20px;
                line-height: 1.4;
            }
            
            .options {
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .option {
                padding: 15px;
                font-size: 15px;
                border-radius: 0; /* Make buttons square on mobile */
            }
            
            .option-with-image {
                padding: 12px;
            }
            
            .option-image {
                width: 60px;
                height: 60px;
                margin-bottom: 8px;
            }
            
            .option-text {
                font-size: 14px;
                line-height: 1.3;
            }
            
            .button-group {
                margin-top: 20px;
                gap: 12px;
            }
            
            .btn-primary,
            .btn-secondary {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            /* Compact file upload */
            .file-upload-label {
                padding: 20px;
                border-radius: 8px;
            }
            
            .file-upload-label strong {
                font-size: 15px;
            }
            
            .file-upload-instructions {
                font-size: 13px;
                margin-top: 6px;
            }
            
            /* Compact text inputs */
            input[type="text"],
            input[type="email"],
            input[type="tel"],
            textarea {
                padding: 12px;
                font-size: 15px;
                border-radius: 6px;
            }
            
            textarea {
                min-height: 80px;
            }
            
            /* Compact checkbox groups */
            .checkbox-group {
                gap: 10px;
            }
            
            .checkbox-item {
                padding: 10px 12px;
                font-size: 14px;
                border-radius: 6px;
            }
        }

        @media (max-width: 640px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 20px;
                margin-bottom: 5px;
            }
            
            h2 {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            p {
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            .options {
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .option {
                padding: 12px;
                font-size: 14px;
                border-radius: 0; /* Make buttons square on mobile */
            }
            
            .option-with-image {
                padding: 10px;
            }
            
            .option-image {
                width: 50px;
                height: 50px;
                margin-bottom: 6px;
            }
            
            .option-text {
                font-size: 13px;
            }
            
            .button-group {
                margin-top: 15px;
                gap: 10px;
            }
            
            .btn-primary,
            .btn-secondary {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            /* Ultra-compact file upload */
            .file-upload-label {
                padding: 15px;
            }
            
            .file-upload-label strong {
                font-size: 14px;
            }
            
            .file-upload-instructions {
                font-size: 12px;
            }
            
            /* Ultra-compact inputs */
            input[type="text"],
            input[type="email"],
            input[type="tel"],
            textarea {
                padding: 10px;
                font-size: 14px;
            }
            
            textarea {
                min-height: 70px;
            }
            
            .checkbox-item {
                padding: 8px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            
            h1 {
                font-size: 18px;
            }
            
            h2 {
                font-size: 15px;
                margin-bottom: 10px;
            }
            
            p {
                font-size: 13px;
                margin-bottom: 12px;
            }
            
            .options {
                gap: 8px;
                margin-bottom: 12px;
            }
            
            .option {
                padding: 10px;
                font-size: 13px;
                border-radius: 0; /* Make buttons square on mobile */
            }
            
            .option-with-image {
                padding: 8px;
            }
            
            .option-image {
                width: 45px;
                height: 45px;
                margin-bottom: 5px;
            }
            
            .option-text {
                font-size: 12px;
            }
            
            .button-group {
                margin-top: 12px;
                gap: 8px;
            }
            
            .btn-primary,
            .btn-secondary {
                padding: 8px 14px;
                font-size: 12px;
            }
            
            .file-upload-label {
                padding: 12px;
            }
            
            .file-upload-label strong {
                font-size: 13px;
            }
            
            .file-upload-instructions {
                font-size: 11px;
            }
            
            input[type="text"],
            input[type="email"],
            input[type="tel"],
            textarea {
                padding: 8px;
                font-size: 13px;
            }
            
            textarea {
                min-height: 60px;
            }
            
            .checkbox-item {
                padding: 6px 8px;
                font-size: 12px;
            }
        }

        /* Show story section with maximum width on small screens */
        .product-story {
            display: block;
            padding: 10px 12px; /* Compact padding */
            margin: 10px -25px; /* Large negative margin for full screen width */
            border-radius: 0;
            border-left: 3px solid #DAE0FF;
            background: #DAE0FF;
        }
        
        .product-story h6 {
            font-size: 9px;
            margin-bottom: 4px;
            color: #000000;
            font-weight: 600;
        }
        
        .product-story p {
            font-size: 11px;
            line-height: 1.3;
            color: #333333;
            font-weight: 500;
        }

        /* Maximum width story section for tiny screens */
        .product-story {
            padding: 8px 10px; /* Ultra-compact padding */
            margin: 8px -20px; /* Large negative margin for full screen width */
            border-radius: 0;
            border-left: 2px solid #DAE0FF;
            background: #DAE0FF;
        }
        
        .product-story h6 {
            font-size: 8px;
            margin-bottom: 3px;
            color: #000000;
            font-weight: 600;
        }
        
        .product-story p {
            font-size: 10px;
            line-height: 1.2;
            color: #333333;
            font-weight: 500;
        }

        /* Carousel styles - only applied when carousel is created */
        .carousel-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            background: transparent;
        }

        .carousel-track {
            display: flex;
            transition: transform 0.3s ease;
            width: 100%;
            background: transparent;
        }

        .carousel-track img {
            min-width: 100%;
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
            flex-shrink: 0;
            border: none;
            outline: none;
            background: transparent;
            margin: 0;
            padding: 0;
            border-radius: 8px;
        }

        .carousel-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            backdrop-filter: blur(8px);
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .carousel-btn {
            background: #f0f0f0;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            transition: all 0.2s ease;
        }

        .carousel-btn:hover {
            background: #e0e0e0;
            color: #000;
        }

        .carousel-btn:active {
            transform: scale(0.95);
        }

        .carousel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .carousel-indicator {
            font-size: 12px;
            color: #666;
            font-weight: 500;
            min-width: 60px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>



        <!-- Question 1 -->
        <div class="question-container active" data-question="Q1">
            <h2>Let's create your custom charm</h2>
            <p>How much do you already know about what you want?</p>
            <div class="options">
                <div class="option" onclick="selectOption(this, 'A')">
                    I need help with ideas
                </div>
                <div class="option" onclick="selectOption(this, 'B')">
                    I have some ideas
                </div>
                <div class="option" onclick="selectOption(this, 'C')">
                    I know exactly what I want
                </div>
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="handleQ1Branch()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Path C: Q2 -->
        <div class="question-container" data-question="Q2">
            <h2>Perfect! Show me your inspiration</h2>
            <p>Upload any photo, sketch, or reference image</p>
            <div class="file-upload">
                <input type="file" id="q2-file" accept="image/*" onchange="handleFileUpload('q2-file')">
                <label for="q2-file" class="file-upload-label">
                    <strong>Drag & drop your image here</strong>
                    <span class="file-upload-instructions">or click to browse your files</span>
                </label>
                <div class="file-info" id="q2-file-info"></div>
            </div>
            <div class="skip-link">
                <a href="#" onclick="skipUpload(); return false;">I'll describe it instead</a>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="btn-primary" onclick="nextQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Path A: Q3 -->
        <div class="question-container" data-question="Q3">
            <h2>What's the story behind your charm?</h2>
            <div class="options">
                <div class="option option-with-image" onclick="selectOption(this, 'moment')">
                    <img src="images/questions/story/moment.jpg" alt="Special moment" class="option-image">
                    <div class="option-text">
                    Celebrating a special moment
                </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'person')">
                    <img src="images/questions/story/person.jpg" alt="Someone special" class="option-image">
                    <div class="option-text">
                        Honoring someone special
                    </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'place')">
                    <img src="images/questions/story/place.jpg" alt="Meaningful place" class="option-image">
                    <div class="option-text">
                    Remembering a meaningful place
                    </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'curious')">
                    <img src="images/questions/story/curious.jpg" alt="Just browsing" class="option-image">
                    <div class="option-text">
                        Just browsing for something beautiful
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="btn-primary" onclick="nextQuestion()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Path A: Q4 -->
        <div class="question-container" data-question="Q4">
            <h2>Who will wear this charm?</h2>
            <div class="options">
                <div class="option" onclick="selectOption(this, 'for-me')">
                    It's for me
                </div>
                <div class="option" onclick="selectOption(this, 'for-someone')">
                    A gift for someone special
                </div>
                <div class="option" onclick="selectOption(this, 'not-sure')">
                    Still deciding
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="nextQuestion()" disabled>Continue</button>
            </div>
        </div>

        <!-- Paths C & B: Q5 & Q10 (same content, different IDs) -->
        <div class="question-container" data-question="Q5">
            <h2>What style appeals to you?</h2>
            <p>Choose all that feel right (you can select multiple)</p>
            <div class="options multi-select">
                <div class="option" onclick="toggleMultiSelect(this, 'elegant')">
                    Elegant & Timeless
                </div>
                <div class="option" onclick="toggleMultiSelect(this, 'bold')">
                    Bold & Confident
                </div>
                <div class="option" onclick="toggleMultiSelect(this, 'playful')">
                    Playful & Fun
                </div>
                <div class="option" onclick="toggleMultiSelect(this, 'spiritual')">
                    Spiritual & Meaningful
                </div>
                <div class="option" onclick="toggleMultiSelect(this, 'sweet')">
                    Sweet & Sentimental
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="nextQuestion()" disabled>Continue</button>
            </div>
        </div>

        <!-- Path A: Q6 -->
        <div class="question-container" data-question="Q6">
            <h2>What feels meaningful to you?</h2>
            <p>Think about symbols, memories, or elements that hold special meaning</p>
            <textarea placeholder="For example: nature elements, meaningful symbols, initials, or something that represents your journey..."></textarea>
            <div class="skip-link">
                <a href="#" onclick="skipTextInput(); return false;">I'm still exploring - help me decide</a>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="btn-primary" onclick="nextQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Path A: Q7 -->
        <div class="question-container" data-question="Q7">
            <h2>Do you have any inspiration photos? (optional)</h2>
            <div class="file-upload">
                <input type="file" id="q7-file" accept="image/*" onchange="handleFileUpload('q7-file')">
                <label for="q7-file" class="file-upload-label">
                    <strong>Drag & drop inspiration photos here</strong>
                    <span class="file-upload-instructions">or click to browse your files</span>
                </label>
                <div class="file-info" id="q7-file-info"></div>
            </div>
            <div class="skip-link">
                <a href="#" onclick="skipUpload(); return false;">Skip this step</a>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="nextQuestion()">Continue</button>
            </div>
        </div>

        <!-- Path B: Q8 -->
        <div class="question-container" data-question="Q8">
            <h2>Tell me about your idea</h2>
            <textarea placeholder="Describe what you're envisioning... the more details, the better!"></textarea>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="nextQuestion()" disabled>Continue</button>
            </div>
        </div>

        <!-- Path B: Q9 -->
        <div class="question-container" data-question="Q9">
            <h2>Upload any reference images (optional).</h2>
            <div class="file-upload">
                <input type="file" id="q9-file" accept="image/*" multiple onchange="handleFileUpload('q9-file')">
                <label for="q9-file" class="file-upload-label">
                    <strong>Drag & drop reference images here</strong>
                    <span class="file-upload-instructions">or click to browse your files (multiple files OK)</span>
                </label>
                <div class="file-info" id="q9-file-info"></div>
            </div>
            <div class="skip-link">
                <a href="#" onclick="skipUpload(); return false;">Skip this step</a>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="nextQuestion()">Continue</button>
            </div>
        </div>

        <!-- Path B: Q10 (duplicate of Q5) -->
        <div class="question-container" data-question="Q10">
            <h2>What style appeals to you?</h2>
            <p>Choose all that feel right (you can select multiple)</p>
            <div class="options multi-select">
                <div class="option" onclick="toggleMultiSelect(this, 'elegant')">
                    Elegant & Timeless
                </div>
                <div class="option" onclick="toggleMultiSelect(this, 'bold')">
                    Bold & Confident
                </div>
                <div class="option" onclick="toggleMultiSelect(this, 'playful')">
                    Playful & Cute
                </div>
                <div class="option" onclick="toggleMultiSelect(this, 'spiritual')">
                    Spiritual & Symbolic
                </div>
                <div class="option" onclick="toggleMultiSelect(this, 'sweet')">
                    Sweet & Sentimental
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="nextQuestion()" disabled>Continue</button>
            </div>
        </div>

        <!-- Convergence: Q11 -->
        <div class="question-container" data-question="Q11">
            <h2>What size and presence do you prefer?</h2>
            <div class="options">
                <div class="option option-with-image" onclick="selectOption(this, 'subtle')">
                    <img src="images/questions/size/subtle.jpg" alt="Small & delicate" class="option-image">
                    <div class="option-text">
                        Small & delicate
                </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'classic')">
                    <img src="images/questions/size/classic.jpg" alt="Medium & versatile" class="option-image">
                    <div class="option-text">
                        Medium & versatile
                </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'bold-sculptural')">
                    <img src="images/questions/size/bold-sculptural.jpg" alt="Bold & statement-making" class="option-image">
                    <div class="option-text">
                        Bold & statement-making
                    </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'not-sure')">
                    <img src="images/questions/size/not-sure.jpg" alt="I'm not sure yet" class="option-image">
                    <div class="option-text">
                        I'm not sure yet
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="nextQuestion()" disabled>Continue</button>
            </div>
        </div>

        <!-- Q12 -->
        <div class="question-container" data-question="Q12">
            <h2>What material would you prefer?</h2>
            <p>Each option has different qualities and pricing</p>
            <div class="options">
                <div class="option option-with-image" onclick="selectOption(this, '14k-gold')">
                    <img src="images/questions/materials/14k-gold.jpg" alt="14K Gold" class="option-image">
                    <div class="option-text">
                    14K Solid Gold
                    <span style="display: block; font-size: 14px; margin-top: 5px; opacity: 0.7;">Luxurious & lasting</span>
                </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'sterling-silver')">
                    <img src="images/questions/materials/sterling-silver.jpg" alt="Sterling Silver" class="option-image">
                    <div class="option-text">
                    Sterling Silver
                    <span style="display: block; font-size: 14px; margin-top: 5px; opacity: 0.7;">Classic & affordable</span>
                </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'gold-plated')">
                    <img src="images/questions/materials/gold-plated.jpg" alt="Gold Plated" class="option-image">
                    <div class="option-text">
                    Gold-Plated Silver
                    <span style="display: block; font-size: 14px; margin-top: 5px; opacity: 0.7;">Golden look, silver price</span>
                </div>
                </div>
                <div class="option option-with-image" onclick="selectOption(this, 'help-decide')">
                    <img src="images/questions/materials/help-decide.jpg" alt="Help Decide" class="option-image">
                    <div class="option-text">
                    Help me choose
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="nextQuestion()" disabled>Continue</button>
            </div>
        </div>

        <!-- Q13 -->
        <div class="question-container" data-question="Q13">
            <h2>Any special details or requests?</h2>
            <p style="color: #666; font-size: 16px; margin-bottom: 20px;">Amazing! Your custom design is taking shape. Any final touches?</p>
            <textarea placeholder="For example: specific dates, sizing preferences, engraving ideas, or any other notes..."></textarea>
            <div class="skip-link">
                <a href="#" onclick="skipTextInput(); return false;">No special requests</a>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="btn-primary" onclick="nextQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Contact Info -->
        <div class="question-container" data-question="contact">
            <h2>How can we reach you?</h2>
            <p>We'll send your custom design mockup and updates</p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 400; color: #000;">Email address *</label>
                <input type="email" id="contact-email" placeholder="your@email.com" required style="margin-bottom: 15px;">
        </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 400; color: #000;">Phone number (optional)</label>
                <input type="tel" id="contact-phone" placeholder="+1 (555) 123-4567">
                <div style="font-size: 14px; color: #666; margin-top: 5px;">For text updates when your design is ready</div>
            </div>
            
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                <button class="btn-primary" onclick="validateContact()" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <div class="question-container" data-question="community">
            <h2>Can we feature your design in our gallery?</h2>
            <p>We love showcasing beautiful custom pieces to inspire other customers</p>
            <div class="options">
                <div class="option" onclick="selectOption(this, 'yes')">
                    Yes, that sounds great!
                </div>
                <div class="option" onclick="selectOption(this, 'no')">
                    No, keep it private
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="previousQuestion()">Back</button>
                <button class="btn-primary" onclick="submitForm()" disabled>
                    Submit
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Completion -->
        <div class="question-container" data-question="complete">
            <div class="completion-message">
                <h1>You're all set!</h1>
                <p>We'll craft your custom design and send it within 24-48 hours</p>
                <p style="font-size: 16px; margin-top: 20px;">Keep an eye on your inbox - you're going to love what we create together</p>
                <div class="results">
                    <ul class="results-list" id="resultsList">
                        <!-- Results will be populated here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestion = 'Q1';
        let currentQuestionIndex = 0;
        let questionFlow = ['Q1'];
        let questionHistory = [];
        let formData = {};
        let backgroundImagePromise = null;
        
        // Store the actual image generation prompts for accurate story generation
        let imageGenerationPrompts = {
            design1: '',
            design2: '',
            regenerated: {}
        };

        // Auto-save and restore quiz progress
        function saveQuizProgress() {
            const quizState = {
                currentQuestion,
                currentQuestionIndex,
                questionFlow,
                questionHistory,
                formData,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('jewelryQuizProgress', JSON.stringify(quizState));
        }

        function loadQuizProgress() {
            try {
                const savedState = localStorage.getItem('jewelryQuizProgress');
                if (savedState) {
                    const quizState = JSON.parse(savedState);
                    
                    // Check if the saved state is recent (within 24 hours)
                    const saveTime = new Date(quizState.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - saveTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        currentQuestion = quizState.currentQuestion;
                        currentQuestionIndex = quizState.currentQuestionIndex;
                        questionFlow = quizState.questionFlow;
                        questionHistory = quizState.questionHistory;
                        formData = quizState.formData;
                        
                        // Restore form selections
                        restoreFormSelections();
                        
                        // Show the current question
                        showQuestion(currentQuestion);
                        
                        // Show visual indicator that progress was restored
                        showProgressRestoredIndicator();
                        
                        console.log('Quiz progress restored from:', quizState.timestamp);
                        return true;
                    } else {
                        // Clear old state
                        localStorage.removeItem('jewelryQuizProgress');
                    }
                }
            } catch (error) {
                console.error('Error loading quiz progress:', error);
                localStorage.removeItem('jewelryQuizProgress');
            }
            return false;
        }

        function restoreFormSelections() {
            // Restore selected options for all questions
            Object.keys(formData).forEach(questionId => {
                const value = formData[questionId];
                const questionContainer = document.querySelector(`[data-question="${questionId}"]`);
                
                if (questionContainer) {
                    // Restore single-choice selections
                    if (typeof value === 'string') {
                        const option = questionContainer.querySelector(`[onclick*="${value}"]`);
                        if (option) {
                            option.classList.add('selected');
                            const continueBtn = questionContainer.querySelector('.btn-primary');
                            if (continueBtn) continueBtn.disabled = false;
                        }
                    }
                    
                    // Restore multi-choice selections
                    if (Array.isArray(value)) {
                        value.forEach(val => {
                            const option = questionContainer.querySelector(`[onclick*="${val}"]`);
                            if (option) {
                                option.classList.add('selected');
                            }
                        });
                        const continueBtn = questionContainer.querySelector('.btn-primary');
                        if (continueBtn && value.length > 0) continueBtn.disabled = false;
                    }
                    
                    // Restore text inputs
                    const textarea = questionContainer.querySelector('textarea');
                    const emailInput = questionContainer.querySelector('input[type="email"]');
                    const phoneInput = questionContainer.querySelector('input[type="tel"]');
                    
                    if (textarea && formData[questionId]) {
                        textarea.value = formData[questionId];
                    }
                    if (emailInput && formData.email) {
                        emailInput.value = formData.email;
                    }
                    if (phoneInput && formData.phone) {
                        phoneInput.value = formData.phone;
                    }
                }
            });
        }

        function clearQuizProgress() {
            localStorage.removeItem('jewelryQuizProgress');
        }
        
        function showProgressRestoredIndicator() {
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d4edda;
                color: #155724;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                border: 1px solid #c3e6cb;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                animation: slideIn 0.5s ease-out;
            `;
            indicator.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">✓</span>
                    <span>Quiz progress restored! Continuing where you left off.</span>
                </div>
            `;
            
            // Add slide-in animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(indicator);
            
            // Remove after 4 seconds
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.style.animation = 'slideIn 0.5s ease-out reverse';
                    setTimeout(() => {
                        if (indicator.parentNode) {
                            indicator.parentNode.removeChild(indicator);
                        }
                    }, 500);
                }
            }, 4000);
        }

        function updateProgress() {
            const totalQuestions = questionFlow.length;
            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function addArrowToButtons() {
            // Replace all button text with just arrows
            document.querySelectorAll('.btn-primary').forEach(btn => {
                if (btn.textContent.includes('Submit') || btn.innerHTML.includes('20 6 9 17 4 12')) {
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>`;
                } else {
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>`;
                }
            });
            
            document.querySelectorAll('.btn-secondary').forEach(btn => {
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>`;
            });
        }

        function showQuestion(questionId) {
            document.querySelectorAll('.question-container').forEach(container => {
                container.classList.remove('active');
            });
            
            const targetQuestion = document.querySelector(`[data-question="${questionId}"]`);
            if (targetQuestion) {
                targetQuestion.classList.add('active');
                // Add arrows to buttons in the active question
                setTimeout(addArrowToButtons, 10);
            }
            
            updateProgress();
        }

        function nextQuestion() {
            // Save text inputs
            const textarea = document.querySelector(`.question-container.active textarea`);
            const emailInput = document.querySelector(`.question-container.active input[type="email"]`);
            const phoneInput = document.querySelector(`.question-container.active input[type="tel"]`);
            
            if (textarea) {
                formData[currentQuestion] = textarea.value;
            }
            if (emailInput) {
                formData.email = emailInput.value;
            }
            if (phoneInput) {
                formData.phone = phoneInput.value;
            }
            
            questionHistory.push(currentQuestionIndex);
            currentQuestionIndex++;
            
            if (currentQuestionIndex < questionFlow.length) {
                currentQuestion = questionFlow[currentQuestionIndex];
                showQuestion(questionFlow[currentQuestionIndex]);
            }
        }

        function previousQuestion() {
            if (questionHistory.length > 0) {
                currentQuestionIndex = questionHistory.pop();
                showQuestion(questionFlow[currentQuestionIndex]);
            }
        }

        function selectOption(element, value) {
            const container = element.parentElement;
            container.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            
            const questionId = element.closest('.question-container').dataset.question;
            formData[questionId] = value;
            
            // Enable continue button
            const continueBtn = element.closest('.question-container').querySelector('.btn-primary');
            if (continueBtn) {
                continueBtn.disabled = false;
            }
            
            // Auto-advance after a short delay for all selection questions
            setTimeout(() => {
                if (questionId === 'Q1') {
                    // Auto-advance after Q1 to build the flow
                    handleQ1Branch();
                } else if (questionId === 'community') {
                    // Auto-advance for final submission
                    submitForm();
                } else {
                    // Auto-advance for all other single-choice questions
                    nextQuestion();
                }
            }, 300);
        }

        function toggleMultiSelect(element, value) {
            element.classList.toggle('selected');
            
            const questionId = element.closest('.question-container').dataset.question;
            if (!formData[questionId]) {
                formData[questionId] = [];
            }
            
            if (element.classList.contains('selected')) {
                formData[questionId].push(value);
            } else {
                formData[questionId] = formData[questionId].filter(v => v !== value);
            }
            
            // Enable continue button if at least one option is selected
            const continueBtn = element.closest('.question-container').querySelector('.btn-primary');
            if (continueBtn) {
                continueBtn.disabled = formData[questionId].length === 0;
            }
            
            // Auto-advance after selecting at least one option and a delay
            if (formData[questionId].length > 0) {
                clearTimeout(window.multiSelectTimer);
                window.multiSelectTimer = setTimeout(() => {
                    nextQuestion();
                }, 1500); // Longer delay for multi-select to allow multiple selections
            }
        }

        function handleQ1Branch() {
            const answer = formData.Q1;
            
            // Build the appropriate flow based on the answer
            if (answer === 'A') {
                // Path A: Need help
                questionFlow = ['Q1', 'Q3', 'Q4', 'Q6', 'Q7', 'Q11', 'Q12', 'Q13', 'contact', 'community', 'complete'];
            } else if (answer === 'B') {
                // Path B: Have ideas
                questionFlow = ['Q1', 'Q8', 'Q9', 'Q10', 'Q11', 'Q12', 'Q13', 'contact', 'community', 'complete'];
            } else if (answer === 'C') {
                // Path C: Know exactly
                questionFlow = ['Q1', 'Q2', 'Q5', 'Q11', 'Q12', 'Q13', 'contact', 'community', 'complete'];
            }
            
            nextQuestion();
        }

        function handleFileUpload(inputId) {
            const fileInput = document.getElementById(inputId);
            const fileInfo = document.getElementById(inputId + '-info');
            
            if (fileInput.files.length > 0) {
                const newFiles = Array.from(fileInput.files);
                const questionId = fileInput.closest('.question-container').dataset.question;
                
                // Get existing files if any
                const existingFiles = formData[questionId + '_files'] || [];
                const existingBase64 = formData[questionId + '_base64'] || [];
                
                // Combine existing and new files
                const allFiles = [...existingFiles, ...newFiles];
                const allFileNames = allFiles.map(f => f.name).join(', ');
                
                // Update form data
                formData[questionId + '_files'] = allFiles;
                
                // Update file info display
                const fileCount = allFiles.length;
                fileInfo.innerHTML = `<div style="color: #000; font-weight: 400; margin: 10px 0;">${fileCount} file${fileCount > 1 ? 's' : ''} selected: ${allFileNames}</div>`;
                
                // Convert new images to base64 and combine with existing
                convertFilesToBase64(newFiles, questionId, existingBase64);
                showImagePreviews(allFiles, fileInfo);
                
                // Update the upload label to show success and ability to add more
                const label = fileInput.nextElementSibling;
                label.style.background = '#d4edda';
                label.style.borderColor = '#28a745';
                label.innerHTML = `
                    <strong>${fileCount} file${fileCount > 1 ? 's' : ''} uploaded!</strong>
                    <span class="file-upload-instructions">Click to add more files or replace all</span>
                `;
                
                // Add "Add More" button
                addMoreFilesButton(fileInput, questionId);
            }
        }

        function addMoreFilesButton(originalInput, questionId) {
            const container = originalInput.closest('.file-upload');
            
            // Remove existing buttons if they exist
            const existingButton = container.querySelector('.add-more-button');
            const existingClearButton = container.querySelector('.clear-all-button');
            const existingAdditionalInput = container.querySelector('input[type="file"][style*="display: none"]');
            
            if (existingButton) existingButton.remove();
            if (existingClearButton) existingClearButton.remove();
            if (existingAdditionalInput) existingAdditionalInput.remove();
            
            // Remove button container if it exists
            const existingButtonContainer = container.querySelector('div[style*="display: flex"]');
            if (existingButtonContainer) existingButtonContainer.remove();
            
            // Create "Add More" button
            const addMoreButton = document.createElement('button');
            addMoreButton.className = 'add-more-button';
            addMoreButton.type = 'button';
            addMoreButton.style.cssText = `
                margin-top: 10px;
                padding: 8px 16px;
                background: #f8f8f8;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            addMoreButton.innerHTML = '+ Add More Images';
            
            // Add hover effects
            addMoreButton.onmouseover = function() {
                this.style.background = '#DAE0FF';
                this.style.borderColor = '#000';
            };
            addMoreButton.onmouseout = function() {
                this.style.background = '#f8f8f8';
                this.style.borderColor = '#ddd';
            };
            
            // Create hidden file input for additional files
            const additionalInput = document.createElement('input');
            additionalInput.type = 'file';
            additionalInput.accept = 'image/*';
            additionalInput.multiple = true;
            additionalInput.style.display = 'none';
            
            // Handle additional file selection
            additionalInput.onchange = function() {
                if (this.files.length > 0) {
                    const newFiles = Array.from(this.files);
                    const existingFiles = formData[questionId + '_files'] || [];
                    const existingBase64 = formData[questionId + '_base64'] || [];
                    
                    // Combine files
                    const allFiles = [...existingFiles, ...newFiles];
                    formData[questionId + '_files'] = allFiles;
                    
                    // Update display
                    const fileInfo = document.getElementById(originalInput.id + '-info');
                    const allFileNames = allFiles.map(f => f.name).join(', ');
                    const fileCount = allFiles.length;
                    fileInfo.innerHTML = `<div style="color: #000; font-weight: 400; margin: 10px 0;">${fileCount} file${fileCount > 1 ? 's' : ''} selected: ${allFileNames}</div>`;
                    
                    // Convert new images and update previews
                    convertFilesToBase64(newFiles, questionId, existingBase64);
                    showImagePreviews(allFiles, fileInfo);
                    
                    // Update main label
                    const label = originalInput.nextElementSibling;
                    label.innerHTML = `
                        <strong>${fileCount} file${fileCount > 1 ? 's' : ''} uploaded!</strong>
                        <span class="file-upload-instructions">Click to add more files or replace all</span>
                    `;
                    
                    // Reset the additional input for next use
                    this.value = '';
                }
            };
            
            // Click handler for the button
            addMoreButton.onclick = function() {
                additionalInput.click();
            };
            
            // Create "Clear All" button
            const clearButton = document.createElement('button');
            clearButton.className = 'clear-all-button';
            clearButton.type = 'button';
            clearButton.style.cssText = `
                margin-top: 10px;
                margin-left: 10px;
                padding: 8px 16px;
                background: #fff;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s ease;
                color: #666;
            `;
            clearButton.innerHTML = 'Clear All';
            
            // Add hover effects for clear button
            clearButton.onmouseover = function() {
                this.style.background = '#ffebee';
                this.style.borderColor = '#f44336';
                this.style.color = '#f44336';
            };
            clearButton.onmouseout = function() {
                this.style.background = '#fff';
                this.style.borderColor = '#ddd';
                this.style.color = '#666';
            };
            
            // Clear all files handler
            clearButton.onclick = function() {
                if (confirm('Are you sure you want to remove all uploaded images?')) {
                    // Clear form data
                    formData[questionId + '_files'] = [];
                    formData[questionId + '_base64'] = [];
                    
                    // Reset original input
                    originalInput.value = '';
                    
                    // Reset label
                    const label = originalInput.nextElementSibling;
                    label.style.background = '#ffffff';
                    label.style.borderColor = '#000000';
                    label.innerHTML = `
                        <strong>Drag & drop your images here</strong>
                        <span class="file-upload-instructions">or click to browse your files</span>
                    `;
                    
                    // Clear file info
                    const fileInfo = document.getElementById(originalInput.id + '-info');
                    fileInfo.innerHTML = '';
                    
                    // Remove preview containers
                    const existingContainers = container.querySelectorAll('.image-preview-container');
                    existingContainers.forEach(cont => cont.remove());
                    
                    // Remove buttons
                    addMoreButton.remove();
                    clearButton.remove();
                    additionalInput.remove();
                }
            };
            
            // Create button container
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; align-items: center;';
            buttonContainer.appendChild(addMoreButton);
            buttonContainer.appendChild(clearButton);
            
            // Add elements to container
            container.appendChild(additionalInput);
            container.appendChild(buttonContainer);
        }

        // Drag and drop functionality - fixed version
        function setupDragAndDrop() {
            console.log('Setting up drag and drop...');
            
            // Remove any existing global listeners first
            document.removeEventListener('dragover', preventDefaults);
            document.removeEventListener('drop', preventDefaults);
            
            // Add global prevention of default behaviors
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            document.addEventListener('dragover', preventDefaults);
            document.addEventListener('drop', preventDefaults);
            
            // Get all file upload containers
            const uploadContainers = document.querySelectorAll('.file-upload');
            console.log('Found upload containers:', uploadContainers.length);
            
            uploadContainers.forEach((container, index) => {
                const fileInput = container.querySelector('input[type="file"]');
                if (!fileInput) {
                    console.log('No file input found in container', index);
                    return;
                }
                
                const inputId = fileInput.id;
                const label = container.querySelector('.file-upload-label');
                
                console.log('Setting up drag and drop for:', inputId);
                
                // Skip if already has drag-drop-setup attribute
                if (container.hasAttribute('data-drag-drop-setup')) {
                    console.log('Drag and drop already setup for:', inputId);
                    return;
                }
                
                // Mark as setup to prevent duplicate setup
                container.setAttribute('data-drag-drop-setup', 'true');
                
                // Drag enter
                container.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Drag enter on:', inputId);
                    
                    if (label) {
                        label.classList.add('drag-over');
                        container.classList.add('drag-active');
                    }
                });
                
                // Drag over
                container.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.dataTransfer.dropEffect = 'copy';
                });
                
                // Drag leave
                container.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Check if we're really leaving the container
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX;
                    const y = e.clientY;
                    
                    if (x <= rect.left || x >= rect.right || y <= rect.top || y >= rect.bottom) {
                        console.log('Drag leave on:', inputId);
                        if (label) {
                            label.classList.remove('drag-over');
                            container.classList.remove('drag-active');
                        }
                    }
                });
                
                // Drop
                container.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Drop event triggered on:', inputId);
                    
                    if (label) {
                        label.classList.remove('drag-over');
                        container.classList.remove('drag-active');
                    }
                    
                    const files = e.dataTransfer.files;
                    console.log('Files dropped:', files.length);
                    
                    if (files && files.length > 0) {
                        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                        console.log('Image files found:', imageFiles.length);
                        
                        if (imageFiles.length > 0) {
                            // Create a new DataTransfer object to set files
                            const dt = new DataTransfer();
                            
                            // Get existing files if any
                            const existingFiles = formData[inputId.replace('-file', '') + '_files'] || [];
                            
                            // Add existing files first
                            existingFiles.forEach(file => {
                                dt.items.add(file);
                            });
                            
                            // Add new files
                            imageFiles.forEach(file => {
                                dt.items.add(file);
                            });
                            
                            // Set the files on the input
                            fileInput.files = dt.files;
                            
                            // Trigger the upload handler
                            console.log('Triggering handleFileUpload for:', inputId);
                            handleFileUpload(inputId);
                        } else {
                            alert('Please drop only image files (JPG, PNG, GIF, etc.)');
                        }
                    }
                });
            });
        }



        async function convertFilesToBase64(files, questionId, existingBase64 = []) {
            const newBase64Images = [];
            
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    try {
                        const base64 = await fileToBase64(file);
                        newBase64Images.push(base64);
                    } catch (error) {
                        console.error('Error converting file to base64:', error);
                    }
                }
            }
            
            if (newBase64Images.length > 0) {
                // Combine existing and new base64 images
                const allBase64Images = [...existingBase64, ...newBase64Images];
                formData[questionId + '_base64'] = allBase64Images;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function skipUpload() {
            const currentQuestion = document.querySelector('.question-container.active').dataset.question;
            
            if (currentQuestion === 'Q2') {
                // Path C: Skip upload and go to describe idea (Q8), then size (Q11)
                questionFlow = ['Q1', 'Q2', 'Q8', 'Q11', 'Q12', 'Q13', 'contact', 'community', 'complete'];
                // Jump to Q8 (Tell me about your idea)
                currentQuestionIndex = 2; // Q8 is at index 2 in the new flow
                showQuestion('Q8');
            } else {
                // For other upload questions, just continue normally
            nextQuestion();
            }
        }

        function skipTextInput() {
            const textarea = document.querySelector('.question-container.active textarea');
            if (textarea) {
                textarea.value = '';
            }
            nextQuestion();
        }

        function skipPhone() {
            formData.phone = '';
            nextQuestion();
        }

        function validateContact() {
            const emailInput = document.querySelector('#contact-email');
            const phoneInput = document.querySelector('#contact-phone');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (emailInput && emailRegex.test(emailInput.value)) {
                // Save email and phone
                formData.email = emailInput.value;
                formData.phone = phoneInput.value.trim() || '';
                
                // Start image generation in background immediately
                startBackgroundImageGeneration();
                
                // Show a subtle indicator that generation has started
                showGenerationStartedIndicator();
                
                nextQuestion();
            }
            // Removed alert popup - just don't advance if email is invalid
        }

        // Start background generation even earlier when user starts typing email
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const emailInput = document.querySelector('#contact-email');
                if (emailInput) {
                    emailInput.addEventListener('input', function() {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (emailRegex.test(this.value) && !backgroundImagePromise) {
                            console.log('Starting early background generation...');
                            formData.email = this.value;
                            startBackgroundImageGeneration();
                        }
                    });
                }
            }, 1000);
        });

        async function ensureConfigLoaded() {
            // Check if config is already loaded
            if (window.CONFIG?.OPENAI_API_KEY || window.OPENAI_API_KEY) {
                console.log('Config already loaded');
                return true;
            }
            
            console.log('Config not loaded, attempting to fetch from server...');
            
            // List of endpoints to try
            const endpoints = [
                '/config.js',      // Rewritten to /api/config
                '/api/config',     // Direct API endpoint
                '/api/config.js'   // Alternative API endpoint
            ];
            
            // Try each endpoint
            for (const endpoint of endpoints) {
                try {
                    console.log(`Trying endpoint: ${endpoint}`);
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/javascript, text/javascript, */*',
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    console.log(`Response from ${endpoint}:`, response.status, response.statusText);
                    
                    if (response.ok) {
                        const configScript = await response.text();
                        console.log(`Config script fetched from ${endpoint}:`, configScript.substring(0, 50) + '...');
                        
                        // Execute the script
                        try {
                            eval(configScript);
                            console.log('After eval - window.CONFIG:', !!window.CONFIG);
                            console.log('After eval - window.OPENAI_API_KEY:', !!window.OPENAI_API_KEY);
                            
                            if (window.CONFIG?.OPENAI_API_KEY || window.OPENAI_API_KEY) {
                                console.log(`Config loaded successfully from ${endpoint}`);
                                return true;
                            }
                        } catch (evalError) {
                            console.error(`Error executing config script from ${endpoint}:`, evalError);
                        }
                    } else {
                        console.error(`Failed to fetch config from ${endpoint}:`, response.status, response.statusText);
                    }
                } catch (error) {
                    console.error(`Error loading config from ${endpoint}:`, error);
                }
            }
            
            // If all server endpoints failed, always prompt user for API key
            console.log('All server endpoints failed, prompting user for API key...');
            
            const apiKey = prompt('The server configuration is not available. Please enter your OpenAI API key to enable image generation (starts with sk-):');
            if (apiKey && apiKey.startsWith('sk-')) {
                window.CONFIG = { OPENAI_API_KEY: apiKey };
                window.OPENAI_API_KEY = apiKey;
                console.log('API key provided by user');
                return true;
            } else if (apiKey) {
                alert('Invalid API key format. API keys should start with "sk-"');
            }
            
            console.log('No valid API key available');
            return false;
        }

        async function startBackgroundImageGeneration() {
            try {
                console.log('Starting background image generation...');
                
                // Ensure config is loaded
                const configLoaded = await ensureConfigLoaded();
                if (!configLoaded) {
                    console.log('Could not load config, skipping background generation');
                    return;
                }
                
                // Debug: Check if CONFIG is loaded
                console.log('window.CONFIG:', window.CONFIG);
                console.log('window.OPENAI_API_KEY:', window.OPENAI_API_KEY);
                
                // Get API key from config or prompt for it
                let apiKey = window.CONFIG?.OPENAI_API_KEY || window.OPENAI_API_KEY;
                console.log('API key available:', !!apiKey);
                console.log('API key length:', apiKey ? apiKey.length : 0);
                
                if (!apiKey) {
                    console.log('No API key available, skipping background generation');
                    return;
                }
                
                const responses = captureAllResponses();
                const promptData = generatePromptFromResponses(responses);
                
                // Check if we have uploaded images to incorporate
                const hasUploadedImages = responses.uploaded_images.Q2_images.length > 0 || 
                                        responses.uploaded_images.Q7_images.length > 0 || 
                                        responses.uploaded_images.Q9_images.length > 0;
                
                let promptText;
                let inputContent = [];
                
                if (hasUploadedImages) {
                    // Create prompt that incorporates the uploaded images
                    if (responses.uploaded_images.Q2_images.length > 0) {
                        // Path C: Exact design - make this image into a charm
                        promptText = `Transform this image into a single ${promptData.material} charm with an attachment loop. 

IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive charm form.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should be a single, standalone charm with elegant details and proper proportions. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                        
                        // Add the uploaded image(s) to input
                        inputContent.push({
                            "type": "input_text",
                            "text": promptText
                        });
                        
                        responses.uploaded_images.Q2_images.forEach(imageBase64 => {
                            inputContent.push({
                                "type": "input_image",
                                "image_url": imageBase64
                            });
                        });
                    } else {
                        // Path A or B: Combine text preferences with image inspiration
                        // Build detailed user preferences from ALL survey responses
                        let detailedPreferences = `
USER SURVEY RESPONSES TO INCORPORATE:
- Material: ${promptData.material}
- Style: ${promptData.style}
- Subject/Theme: ${promptData.subject}`;

                        // Add all text responses
                        if (responses.inspiration) {
                            detailedPreferences += `\n- Story/Inspiration: ${responses.inspiration}`;
                        }
                        if (responses.all_text_responses.Q6_symbols) {
                            detailedPreferences += `\n- Meaningful Symbols/Elements: ${responses.all_text_responses.Q6_symbols}`;
                        }
                        if (responses.all_text_responses.Q8_idea_description) {
                            detailedPreferences += `\n- User's Idea Description: ${responses.all_text_responses.Q8_idea_description}`;
                        }
                        if (responses.style_vibes && responses.style_vibes.length > 0) {
                            detailedPreferences += `\n- Style Vibes: ${responses.style_vibes.join(', ')}`;
                        }
                        if (responses.size_presence) {
                            detailedPreferences += `\n- Size Preference: ${responses.size_presence}`;
                        }
                        if (responses.all_text_responses.Q13_special_details) {
                            detailedPreferences += `\n- Special Details/Requests: ${responses.all_text_responses.Q13_special_details}`;
                        }
                        if (responses.recipient) {
                            detailedPreferences += `\n- Recipient: ${responses.recipient}`;
                        }

                        promptText = `Create a single ${promptData.subject} charm with an attachment loop, incorporating the user's survey responses with inspiration from the reference image(s).

${detailedPreferences}

IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive charm form.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should incorporate ALL the user's stated survey responses while drawing visual inspiration from the reference images. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                        
                        inputContent.push({
                            "type": "input_text", 
                            "text": promptText
                        });
                        
                        // Add inspiration/reference images
                        const allImages = [...responses.uploaded_images.Q7_images, ...responses.uploaded_images.Q9_images];
                        allImages.forEach(imageBase64 => {
                            inputContent.push({
                                "type": "input_image",
                                "image_url": imageBase64
                            });
                        });
                    }
                } else {
                    // No uploaded images - use text-only prompt
                    promptText = `Create a single ${promptData.subject} with ${promptData.style} styling. Material: ${promptData.material}.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should be a single, standalone charm with elegant details and proper proportions. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.detail}. ${promptData.camera}.`;
                    inputContent.push({
                        "type": "input_text",
                        "text": promptText
                    });
                }
                
                console.log('Background generation prompt:', promptText);
                
                // Generate two separate images for better results
                const promises = [];
                
                // Design 1: Classic Elegant
                let design1Prompt = promptText;
                if (hasUploadedImages) {
                    if (responses.uploaded_images.Q2_images.length > 0) {
                        design1Prompt = `Transform this image into a single ${promptData.material} charm with an attachment loop. 

Create a CLASSIC ELEGANT design: refined relief design with elegant, sophisticated details. Use clean lines, smooth surfaces, and subtle dimensional variations. The design should have a timeless, traditional jewelry aesthetic with polished, refined forms. Focus on graceful proportions and classic beauty. IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive charm form with traditional jewelry craftsmanship.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should be a single, standalone charm with elegant details and proper proportions. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                    } else {
                        design1Prompt = `Create a single ${promptData.subject} charm with an attachment loop, incorporating the user's survey responses with inspiration from the reference image(s).

${detailedPreferences}

Create a CLASSIC ELEGANT design: refined interpretation with elegant, sophisticated details. Use clean lines, smooth surfaces, and subtle dimensional variations. The design should have a timeless, traditional jewelry aesthetic with polished, refined forms. IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive charm form with traditional jewelry craftsmanship.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should incorporate ALL the user's stated survey responses while drawing visual inspiration from the reference images. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                    }
                } else {
                    design1Prompt = `Create a single ${promptData.subject} with ${promptData.style} styling. Material: ${promptData.material}.

Create a CLASSIC ELEGANT design: refined, sophisticated design with elegant details. Use clean lines, smooth surfaces, and subtle dimensional variations. The design should have a timeless, traditional jewelry aesthetic with polished, refined forms. IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive charm form with traditional jewelry craftsmanship.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should be a single, standalone charm with elegant details and proper proportions. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.detail}. ${promptData.camera}.`;
                }
                
                // Design 2: Modern Sculptural  
                let design2Prompt = promptText;
                if (hasUploadedImages) {
                    if (responses.uploaded_images.Q2_images.length > 0) {
                        design2Prompt = `Transform this image into a single ${promptData.material} charm with an attachment loop. 

Create a MODERN SCULPTURAL design: bold, contemporary 3D sculptural charm with dramatic dimensional presence and playful, cartoony artistic forms. Use chunky, angular geometric shapes, asymmetrical compositions, and strong architectural elements with a fun, stylized cartoon aesthetic. Make it statement-making and eye-catching with strong 3D sculptural qualities that feel like modern art with cartoon-inspired character. IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive sculptural form.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should be a single, standalone charm with bold sculptural details. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                    } else {
                        design2Prompt = `Create a single ${promptData.subject} charm with an attachment loop, incorporating the user's survey responses with inspiration from the reference image(s).

${detailedPreferences}

Create a MODERN SCULPTURAL design: bold, contemporary 3D sculptural charm with dramatic dimensional presence and playful, cartoony artistic forms. Use chunky, angular geometric shapes, asymmetrical compositions, and strong architectural elements with a fun, stylized cartoon aesthetic. Make it statement-making and eye-catching with strong 3D sculptural qualities that feel like modern art with cartoon-inspired character. IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive sculptural form.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should incorporate ALL the user's stated survey responses while drawing visual inspiration from the reference images. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                    }
                } else {
                    design2Prompt = `Create a single ${promptData.subject} with ${promptData.style} styling. Material: ${promptData.material}.

Create a MODERN SCULPTURAL design: bold, contemporary 3D sculptural design with dramatic dimensional presence and playful, cartoony artistic forms. Use chunky, angular geometric shapes, asymmetrical compositions, and strong architectural elements with a fun, stylized cartoon aesthetic. Make it statement-making and eye-catching with strong 3D sculptural qualities that feel like modern art with cartoon-inspired character. IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive sculptural form.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should be a single, standalone charm with bold sculptural details. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.detail}. ${promptData.camera}.`;
                }
                
                // Two separate API calls for better quality
                [design1Prompt, design2Prompt].forEach(prompt => {
                    promises.push(fetch('https://api.openai.com/v1/responses', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + apiKey
                        },
                        body: JSON.stringify({
                            model: "gpt-4.1-mini",
                            input: hasUploadedImages ? [{
                                "role": "user",
                                "content": [
                                    {
                                        "type": "input_text",
                                        "text": prompt
                                    },
                                    ...inputContent.filter(item => item.type === "input_image")
                                ]
                            }] : prompt,
                            tools: [{
                                type: "image_generation",
                                quality: "standard",
                                size: "1024x1024",
                                background: "opaque"
                            }]
                        })
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    }));
                });
                
                backgroundImagePromise = Promise.all(promises).then(results => {
                    console.log('Background generation results:', results);
                    
                    const combinedData = {
                        output: []
                    };
                    
                    results.forEach((result, index) => {
                        console.log(`Result ${index + 1}:`, result);
                        if (result.output && Array.isArray(result.output)) {
                            const imageCall = result.output.find(output => output.type === "image_generation_call");
                            if (imageCall) {
                                combinedData.output.push(imageCall);
                            }
                        }
                    });
                    
                    console.log('Combined background data:', combinedData);
                    return combinedData;
                }).catch(error => {
                    console.error('Background generation failed:', error);
                    return null;
                });
                
                console.log('Background image generation started');
                
            } catch (error) {
                console.error('Error starting background image generation:', error);
                backgroundImagePromise = null;
            }
        }

        function showGenerationStartedIndicator() {
            // Add a subtle indicator to the page that generation has started
            const indicator = document.createElement('div');
            indicator.id = 'generation-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #DAE0FF;
                color: #000;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 1000;
                border: 1px solid #000;
                animation: fadeInOut 3s ease-in-out;
            `;
            indicator.textContent = 'Generating your charm design...';
            
            // Add fade animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translateY(-10px); }
                    20% { opacity: 1; transform: translateY(0); }
                    80% { opacity: 1; transform: translateY(0); }
                    100% { opacity: 0; transform: translateY(-10px); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(indicator);
            
            // Remove after animation
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 3000);
        }



        function submitForm() {
            // Save final answer
            formData.community = document.querySelector('.question-container.active .option.selected').textContent.trim();
            
            // Save design data before generating results
            saveDesignData();
            
            // Generate results summary
            generateResults();
            
            // Clear saved progress since quiz is complete
            clearQuizProgress();
            
            nextQuestion();
        }

        async function saveDesignData() {
            try {
                const responses = captureAllResponses();
                
                // Prepare design data for saving
                const designData = {
                    timestamp: new Date().toISOString(),
                    responses: responses,
                    quiz_version: '1.0',
                    user_agent: navigator.userAgent,
                    // Add any generated images if available
                    generated_images: {
                        design1: window.generatedImages?.design1 || null,
                        design2: window.generatedImages?.design2 || null
                    }
                };

                // Send to backend for saving and email
                const response = await fetch('/api/save-design', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: responses.email,
                        designData: designData,
                        images: designData.generated_images
                    })
                });

                if (response.ok) {
                    console.log('Design saved and email sent successfully');
                    
                    // Store in localStorage as backup
                    const userDesigns = JSON.parse(localStorage.getItem('userDesigns') || '[]');
                    userDesigns.push({
                        email: responses.email,
                        designData: designData,
                        saved_at: new Date().toISOString()
                    });
                    
                    // Keep only last 10 designs per browser
                    if (userDesigns.length > 10) {
                        userDesigns.splice(0, userDesigns.length - 10);
                    }
                    
                    localStorage.setItem('userDesigns', JSON.stringify(userDesigns));
                } else {
                    console.error('Failed to save design:', await response.text());
                }
            } catch (error) {
                console.error('Error saving design data:', error);
                
                // Fallback: save to localStorage only
                const responses = captureAllResponses();
                const userDesigns = JSON.parse(localStorage.getItem('userDesigns') || '[]');
                userDesigns.push({
                    email: responses.email,
                    designData: {
                        timestamp: new Date().toISOString(),
                        responses: responses,
                        fallback_save: true
                    },
                    saved_at: new Date().toISOString()
                });
                localStorage.setItem('userDesigns', JSON.stringify(userDesigns));
            }
        }

        function generateResults() {
            // Expand container for results page
            const container = document.querySelector('.container');
            container.classList.add('results-mode');
            
            // Generate and display the charm image
            generateCharmImage();
            
            // Debug: Show captured responses and generated prompt
            console.log('All captured responses:', captureAllResponses());
            console.log('Generated prompt data:', generatePromptFromResponses(captureAllResponses()));
        }

        async function generateStoryFromCharmImage(charmImageUrl, responses) {
            try {
                // Get API key
                let apiKey = window.CONFIG?.OPENAI_API_KEY || window.OPENAI_API_KEY;
                if (!apiKey) {
                    console.log('No API key available for charm image story generation');
                    // Fall back to text-based story generation
                    generateDesignStory(responses, 'charm-based');
                    return;
                }

                // Get the actual image generation prompt that was used
                let actualPrompt = '';
                if (imageGenerationPrompts.design1) {
                    actualPrompt = imageGenerationPrompts.design1; // Use the first design's prompt as default
                } else if (imageGenerationPrompts.basePrompt) {
                    actualPrompt = imageGenerationPrompts.basePrompt;
                }

                // Create a comprehensive prompt that combines the charm image with survey context AND the actual generation prompt
                let surveyContext = '';
                if (responses.inspiration) {
                    surveyContext += `\nUser's inspiration: "${responses.inspiration}"`;
                }
                if (responses.symbols) {
                    surveyContext += `\nMeaningful elements requested: "${responses.symbols}"`;
                }
                if (responses.all_text_responses?.Q8_idea_description) {
                    surveyContext += `\nUser's idea description: "${responses.all_text_responses.Q8_idea_description}"`;
                }
                if (responses.all_text_responses?.Q13_special_details) {
                    surveyContext += `\nSpecial details requested: "${responses.all_text_responses.Q13_special_details}"`;
                }
                if (responses.recipient) {
                    surveyContext += `\nThis charm is for: ${responses.recipient}`;
                }
                if (responses.style_vibes && responses.style_vibes.length > 0) {
                    surveyContext += `\nDesired style vibes: ${responses.style_vibes.join(', ')}`;
                }

                const charmAnalysisPrompt = `Look at this custom charm design and write exactly 1-2 simple, heartfelt sentences about what this charm represents and why it would be meaningful to wear.

IMPORTANT CONTEXT FROM USER'S SURVEY:${surveyContext}

ACTUAL IMAGE GENERATION PROMPT USED:
"${actualPrompt}"

Focus on what you can see in the charm design and connect it to both the user's personal story from their survey responses AND the specific design elements that were requested in the generation prompt above. Describe what this specific charm depicts and how it relates to their inspiration, meaningful elements, or personal story. Use warm, simple language that tells the story of what this charm represents based on the visual design, the user's personal context, AND what was actually requested to be generated.

Be specific about the actual design elements you see and how they connect to both the user's intentions and the generation prompt rather than generic statements.`;

                // Build messages array with the generated charm image
                const messageContent = [
                    {
                        "type": "text",
                        "text": charmAnalysisPrompt
                    },
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": charmImageUrl
                        }
                    }
                ];

                const messages = [{
                    "role": "user",
                    "content": messageContent
                }];

                console.log('Generating story from actual charm image...');

                // Make API call using GPT-4o for image analysis
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: messages,
                        max_tokens: 120,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    console.error('Story generation API error:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error details:', errorText);
                    // Fall back to the original story generation method instead of throwing
                    generateDesignStory(responses, 'charm-based');
                    return;
                }
                
                const data = await response.json();

                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    const story = data.choices[0].message.content.trim();
                    
                    // Update the story section in the sidebar
                    const storySection = document.getElementById('sidebar-story');
                    if (storySection) {
                        storySection.innerHTML = `
                            <h6 style="margin: 0 0 8px 0; color: #000000; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">The Story</h6>
                            <p style="margin: 0; color: #333333; font-size: 14px; line-height: 1.5; font-style: italic; font-weight: 400;">${story}</p>
                        `;
                    }
                    
                    console.log('Story generated from charm image:', story);
                } else {
                    console.error('Invalid response from charm image story generation API:', data);
                    // Fall back to the original story generation method
                    generateDesignStory(responses, 'charm-based');
                }

            } catch (error) {
                console.error('Error generating story from charm image:', error);
                // Fall back to the original story generation method
                generateDesignStory(responses, 'charm-based');
            }
        }

        function captureAllResponses() {
            // Capture current text inputs from active forms before finalizing
            document.querySelectorAll('textarea, input[type="text"]').forEach(input => {
                const questionContainer = input.closest('.question-container');
                if (questionContainer && input.value.trim()) {
                    const questionId = questionContainer.dataset.question;
                    formData[questionId] = input.value.trim();
                }
            });

            const responses = {
                journey_type: formData.Q1,
                inspiration: formData.Q3 || formData.Q8, // Q3 for Path A, Q8 for Path B
                recipient: formData.Q4,
                style_vibes: formData.Q5 || formData.Q10 || [],
                symbols: formData.Q6, // Path A: meaningful symbols/elements
                size_presence: formData.Q11,
                material: formData.Q12,
                special_details: formData.Q13, // Final special requests
                email: formData.email,
                phone: formData.phone,
                community_share: formData.community,
                // Include ALL text responses for comprehensive prompt building
                all_text_responses: {
                    Q6_symbols: formData.Q6 || '', // Path A: What feels meaningful
                    Q8_idea_description: formData.Q8 || '', // Path B: Tell me about your idea
                    Q13_special_details: formData.Q13 || '' // Final special requests
                },
                // Include uploaded images
                uploaded_images: {
                    Q2_images: formData.Q2_base64 || [], // Path C: exact design images
                    Q7_images: formData.Q7_base64 || [], // Path A: inspiration images
                    Q9_images: formData.Q9_base64 || []  // Path B: reference images
                }
            };
            return responses;
        }

        function generatePromptFromResponses(responses) {
            // Determine object description based on responses
            let objectDescription = 'elegant charm';
            
            if (responses.symbols) {
                objectDescription = responses.symbols.toLowerCase();
            } else if (responses.inspiration) {
                if (responses.inspiration.includes('moment')) objectDescription = 'commemorative medallion';
                else if (responses.inspiration.includes('person')) objectDescription = 'heart-shaped pendant';
                else if (responses.inspiration.includes('place')) objectDescription = 'compass or map-inspired charm';
                else if (responses.inspiration.includes('curious')) objectDescription = 'geometric charm';
            }
            
            // Determine material based on selection - only gold or silver
            let materialType = 'polished reflective silver metal';
            let materialColor = 'silver';
            if (responses.material === '14k-gold') {
                materialType = 'polished reflective gold metal';
                materialColor = 'gold';
            } else if (responses.material === 'gold-plated') {
                materialType = 'polished reflective gold metal';
                materialColor = 'gold';
            } else {
                // sterling-silver or any other option defaults to silver
                materialType = 'polished reflective silver metal';
                materialColor = 'silver';
            }
            
            // Adjust style based on size preference
            let styleAdjustment = `high-gloss 3D sculptural ${materialColor} metal`;
            if (responses.size_presence === 'subtle') {
                styleAdjustment = `delicate high-gloss 3D sculptural ${materialColor} metal with fine details`;
            } else if (responses.size_presence === 'bold-sculptural') {
                styleAdjustment = `bold high-gloss 3D sculptural ${materialColor} metal with dramatic presence`;
            }
            
            // Incorporate style vibes
            let vibeAdjustment = '';
            if (responses.style_vibes && responses.style_vibes.length > 0) {
                if (responses.style_vibes.includes('elegant')) vibeAdjustment += ', elegant and refined';
                if (responses.style_vibes.includes('bold')) vibeAdjustment += ', bold and confident';
                if (responses.style_vibes.includes('playful')) vibeAdjustment += ', playful and whimsical';
                if (responses.style_vibes.includes('spiritual')) vibeAdjustment += ', meaningful and symbolic';
                if (responses.style_vibes.includes('sweet')) vibeAdjustment += ', sweet and sentimental';
            }

            const prompt = {
                "subject": `a single ${materialColor} charm in the shape of ${objectDescription}${vibeAdjustment}`,
                "style": styleAdjustment,
                "material": materialType,
                "lighting": "studio lighting with soft reflections and minimal shadows",
                "background": "clean off-white or cream gradient",
                "presentation": "floating product shot, single charm with attachment loop attached, angled to show volume and shine",
                "detail": "smooth, rounded surfaces with subtle contours, includes an attachment loop for attachment, no engraving or texture",
                "camera": "close-up, eye-level with a slight tilt",
                "manufacturing_rules": `
CRITICAL 3D DESIGN RULES:
- Focus entirely on the main subject (people, animals, objects, food, plants, fantasy creatures, etc.)
- NO background elements, bases, scenery, or frames — only the subject
- ABSOLUTELY NO FLOATING OR DISCONNECTED ELEMENTS: All parts of the design must be physically connected and grounded as one unified piece
- For people and animals: Simplify faces into soft, minimal features (small eyes, subtle nose/mouth, no exaggerated expressions), avoid cartoon exaggeration — aim for natural, serene, or affectionate emotion
- For objects/food/plants/buildings: Keep forms bold, simple, iconic, and easily recognizable
- Strongly emphasize smooth, rounded volumes and bold silhouettes with deeper grooves, softly padded surfaces, and clean flowing curves to enhance the 3D feel
- Simplify all textures: NO fine patterns, tiny folds, or mechanical details — only large, clear shapes
- Prioritize maximum readability
- MATERIAL: Use only ${materialColor} metal finish - no other colors, gemstones, or mixed materials

MEDALLION RULES:
- If the subject has thin, fragile, or widely spread parts (e.g., arms, tails, wings), contain the design inside a soft organic circular or oval medallion for strength
- If the subject is naturally compact and sturdy, leave it free-floating and self-contained without a background frame
- ALL elements must be connected - no separate floating pieces

MANUFACTURING CONSTRAINTS:
- No full 3D bodies: All parts must rise smoothly from a single, slightly curved back surface (true 2.5D relief)
- Include a single integrated attachment loop as part of the design — no separate jump rings or additional hardware needed
- All outer edges must be softly rounded and thick enough to ensure durability
- Create significant dimensional depth with varying heights across the surface - NOT flat engravings
- Ensure all design elements are physically connected and form one cohesive piece`
            };
            
            return prompt;
        }

        async function generateCharmImage() {
            try {
                console.log('=== Starting generateCharmImage ===');
                
                // Debug: Check if CONFIG is loaded
                console.log('window.CONFIG:', window.CONFIG);
                console.log('window.OPENAI_API_KEY:', window.OPENAI_API_KEY);
                
                // Capture responses first, before any other operations
                const responses = captureAllResponses();
                const promptData = generatePromptFromResponses(responses);
                
                // Check if we have uploaded images to incorporate
                const hasUploadedImages = responses.uploaded_images.Q2_images.length > 0 || 
                                        responses.uploaded_images.Q7_images.length > 0 || 
                                        responses.uploaded_images.Q9_images.length > 0;
                
                let promptText;
                if (hasUploadedImages) {
                    if (responses.uploaded_images.Q2_images.length > 0) {
                        promptText = `Transform this image into a single ${promptData.material} charm with an attachment loop. 

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should be a single, standalone charm with elegant details and proper proportions. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                    } else {
                        // Build detailed user preferences from ALL survey responses
                        let detailedPreferences = `
USER SURVEY RESPONSES TO INCORPORATE:
- Material: ${promptData.material}
- Style: ${promptData.style}
- Subject/Theme: ${promptData.subject}`;

                        // Add all text responses
                        if (responses.inspiration) {
                            detailedPreferences += `\n- Story/Inspiration: ${responses.inspiration}`;
                        }
                        if (responses.all_text_responses.Q6_symbols) {
                            detailedPreferences += `\n- Meaningful Symbols/Elements: ${responses.all_text_responses.Q6_symbols}`;
                        }
                        if (responses.all_text_responses.Q8_idea_description) {
                            detailedPreferences += `\n- User's Idea Description: ${responses.all_text_responses.Q8_idea_description}`;
                        }
                        if (responses.style_vibes && responses.style_vibes.length > 0) {
                            detailedPreferences += `\n- Style Vibes: ${responses.style_vibes.join(', ')}`;
                        }
                        if (responses.size_presence) {
                            detailedPreferences += `\n- Size Preference: ${responses.size_presence}`;
                        }
                        if (responses.all_text_responses.Q13_special_details) {
                            detailedPreferences += `\n- Special Details/Requests: ${responses.all_text_responses.Q13_special_details}`;
                        }
                        if (responses.recipient) {
                            detailedPreferences += `\n- Recipient: ${responses.recipient}`;
                        }

                        promptText = `Create a single ${promptData.subject} charm with an attachment loop, incorporating the user's survey responses with inspiration from the reference image(s).

${detailedPreferences}

IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive charm form.

Create ONE charm design only. Do not show multiple variations or designs in the same image.

${promptData.manufacturing_rules}

The design should incorporate ALL the user's stated survey responses while drawing visual inspiration from the reference images. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                    }
                } else {
                    // No uploaded images - use text-only prompt
                    let textOnlyDetails = '';
                    if (responses.all_text_responses.Q6_symbols) {
                        textOnlyDetails += ` Incorporate meaningful symbols/elements: ${responses.all_text_responses.Q6_symbols}.`;
                    }
                    if (responses.all_text_responses.Q8_idea_description) {
                        textOnlyDetails += ` User's idea: ${responses.all_text_responses.Q8_idea_description}.`;
                    }
                    if (responses.all_text_responses.Q13_special_details) {
                        textOnlyDetails += ` Special requests: ${responses.all_text_responses.Q13_special_details}.`;
                    }
                    if (responses.style_vibes && responses.style_vibes.length > 0) {
                        textOnlyDetails += ` Style vibes: ${responses.style_vibes.join(', ')}.`;
                    }
                    
                    promptText = `Create a single ${promptData.subject} with ${promptData.style} styling. Material: ${promptData.material}.${textOnlyDetails} 

${promptData.manufacturing_rules}

IMPORTANT: The design must be a single, unified piece with all elements connected and grounded - NO floating or disconnected elements. All parts must flow together as one cohesive charm form.

${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.detail}. ${promptData.camera}. Generate 2 different design variations.`;
                }
                
                console.log('Generated prompt:', promptText);
                console.log('Has uploaded images:', hasUploadedImages);
                console.log('All captured responses:', responses);
                console.log('Text responses captured:', responses.all_text_responses);
                
                // Store the base prompt for story generation
                imageGenerationPrompts.basePrompt = promptText;
                
                // Add loading indicator
                const resultsDiv = document.querySelector('.results');
                const loadingDiv = document.createElement('div');
                
                // Check if background generation is available
                if (backgroundImagePromise) {
                    loadingDiv.innerHTML = `
                        <div style="text-align: center; margin: 20px 0;">
                            <p style="margin-bottom: 15px;"><em>Finalizing your custom charm design...</em></p>
                            <div class="swimming-logo-container">
                                <svg class="swimming-logo" version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300.000000 166.000000" preserveAspectRatio="xMidYMid meet">
                                    <g transform="translate(0.000000,166.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
                                        <path d="M186 1478 c16 -222 84 -401 209 -547 25 -29 45 -56 43 -60 -2 -3 -29 -50 -61 -104 -96 -161 -171 -366 -202 -554 l-7 -42 94 40 c126 55 255 127 363 204 95 68 295 249 295 267 0 6 -17 25 -37 43 l-38 33 -90 -87 c-50 -47 -125 -112 -168 -144 -87 -66 -246 -162 -254 -154 -10 11 40 143 95 250 30 60 81 144 113 187 l58 79 -37 31 c-94 77 -189 226 -231 364 -31 102 -31 103 47 61 144 -79 302 -225 501 -463 112 -134 297 -316 401 -393 367 -273 719 -319 1070 -138 162 83 355 258 469 423 62 90 64 70 -28 200 -65 92 -200 232 -287 298 -183 140 -353 200 -559 200 -285 -1 -579 -132 -823 -367 -106 -101 -105 -100 -40 -146 l29 -21 92 89 c215 204 461 319 707 330 150 6 234 -11 365 -76 156 -77 299 -201 416 -360 l47 -65 -31 -45 c-17 -25 -67 -84 -112 -130 -206 -215 -424 -321 -660 -322 -333 -2 -639 196 -1026 661 -217 260 -428 424 -644 500 -27 10 -58 21 -67 25 -15 6 -16 0 -12 -67z"/>
                                        <path d="M2194 1090 c-35 -14 -64 -59 -64 -99 0 -86 80 -141 154 -106 130 62 44 259 -90 205z"/>
                                    </g>
                                </svg>
                            </div>
                        </div>`;
                    console.log('Using background-generated image');
                } else {
                    loadingDiv.innerHTML = `
                        <div style="text-align: center; margin: 20px 0;">
                            <p style="margin-bottom: 15px;"><em>Generating your custom charm design...</em></p>
                            <div class="swimming-logo-container">
                                <svg class="swimming-logo" version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300.000000 166.000000" preserveAspectRatio="xMidYMid meet">
                                    <g transform="translate(0.000000,166.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none">
                                        <path d="M186 1478 c16 -222 84 -401 209 -547 25 -29 45 -56 43 -60 -2 -3 -29 -50 -61 -104 -96 -161 -171 -366 -202 -554 l-7 -42 94 40 c126 55 255 127 363 204 95 68 295 249 295 267 0 6 -17 25 -37 43 l-38 33 -90 -87 c-50 -47 -125 -112 -168 -144 -87 -66 -246 -162 -254 -154 -10 11 40 143 95 250 30 60 81 144 113 187 l58 79 -37 31 c-94 77 -189 226 -231 364 -31 102 -31 103 47 61 144 -79 302 -225 501 -463 112 -134 297 -316 401 -393 367 -273 719 -319 1070 -138 162 83 355 258 469 423 62 90 64 70 -28 200 -65 92 -200 232 -287 298 -183 140 -353 200 -559 200 -285 -1 -579 -132 -823 -367 -106 -101 -105 -100 -40 -146 l29 -21 92 89 c215 204 461 319 707 330 150 6 234 -11 365 -76 156 -77 299 -201 416 -360 l47 -65 -31 -45 c-17 -25 -67 -84 -112 -130 -206 -215 -424 -321 -660 -322 -333 -2 -639 196 -1026 661 -217 260 -428 424 -644 500 -27 10 -58 21 -67 25 -15 6 -16 0 -12 -67z"/>
                                        <path d="M2194 1090 c-35 -14 -64 -59 -64 -99 0 -86 80 -141 154 -106 130 62 44 259 -90 205z"/>
                                    </g>
                                </svg>
                            </div>
                        </div>`;
                    console.log('Starting fresh image generation');
                }
                
                loadingDiv.id = 'image-loading';
                resultsDiv.appendChild(loadingDiv);
                
                let data;
                let useBackgroundImages = false;
                
                // Try to use background-generated image first
                if (backgroundImagePromise) {
                    try {
                        data = await backgroundImagePromise;
                        console.log('Background image ready!', data);
                        
                        // Check if we got valid background data
                        if (data && data.output && Array.isArray(data.output) && data.output.length > 0) {
                            // Verify that the images actually have result data
                            const validImages = data.output.filter(item => 
                                item && item.type === "image_generation_call" && item.result
                            );
                            
                            if (validImages.length > 0) {
                                console.log(`Using ${validImages.length} background-generated images, skipping fresh generation`);
                                data.output = validImages; // Use only valid images
                                useBackgroundImages = true;
                            } else {
                                console.log('Background images have no result data, will generate fresh');
                            }
                        } else {
                            console.log('Background data empty or invalid, will generate fresh');
                        }
                    } catch (error) {
                        console.log('Background generation failed, starting fresh:', error);
                    }
                }
                
                // If no background image available or failed, generate fresh
                if (!useBackgroundImages) {
                    // Get API key from config or prompt for it
                    let apiKey = window.CONFIG?.OPENAI_API_KEY || window.OPENAI_API_KEY;
                    console.log('Fresh generation - API key available:', !!apiKey);
                    console.log('Fresh generation - API key length:', apiKey ? apiKey.length : 0);
                    
                    if (!apiKey) {
                        console.error('API key not available for fresh generation');
                        throw new Error('API key not available');
                    }
                    
                    let inputContent = [];
                    
                    if (hasUploadedImages) {
                        inputContent.push({
                            "type": "input_text",
                            "text": promptText
                        });
                        
                        if (responses.uploaded_images.Q2_images.length > 0) {
                            responses.uploaded_images.Q2_images.forEach(imageBase64 => {
                                inputContent.push({
                                    "type": "input_image",
                                    "image_url": imageBase64
                                });
                            });
                        } else {
                            const allImages = [...responses.uploaded_images.Q7_images, ...responses.uploaded_images.Q9_images];
                            allImages.forEach(imageBase64 => {
                                inputContent.push({
                                    "type": "input_image",
                                    "image_url": imageBase64
                                });
                            });
                        }
                    } else {
                        inputContent.push({
                            "type": "input_text",
                            "text": promptText
                        });
                    }
                    
                    // Generate two separate images for better results
                    const design1Prompt = hasUploadedImages ? 
                        promptText.replace('Generate 2 distinct style variations', 'Create Design 1 - Classic Elegant only: refined interpretation with elegant, sophisticated details, clean lines, and timeless traditional jewelry aesthetic with all elements connected as one cohesive piece. IMPORTANT: NO floating or disconnected elements.') :
                        promptText.replace('Generate 2 different design variations', 'Create a classic, elegant design: refined interpretation with elegant, sophisticated details, clean lines, and timeless traditional jewelry aesthetic with all elements connected as one cohesive piece. IMPORTANT: NO floating or disconnected elements.');
                    
                    const design2Prompt = hasUploadedImages ?
                        promptText.replace('Generate 2 distinct style variations', 'Create Design 2 - Modern Sculptural only: bold, contemporary 3D sculptural charm with dramatic dimensional presence, playful cartoony artistic forms, and angular geometric shapes with a fun stylized cartoon aesthetic. Make it statement-making with strong 3D sculptural qualities. IMPORTANT: NO floating or disconnected elements.') :
                        promptText.replace('Generate 2 different design variations', 'Create a modern, sculptural design: bold, contemporary 3D sculptural charm with dramatic dimensional presence, playful cartoony artistic forms, and angular geometric shapes with a fun stylized cartoon aesthetic. Make it statement-making with strong 3D sculptural qualities. IMPORTANT: NO floating or disconnected elements.');
                    
                    // Store the specific design prompts for story generation
                    imageGenerationPrompts.design1 = design1Prompt;
                    imageGenerationPrompts.design2 = design2Prompt;
                    console.log('Stored design prompts for story generation:', imageGenerationPrompts);
                    
                    const promises = [];
                    
                    // Two separate API calls for better quality
                    [design1Prompt, design2Prompt].forEach(prompt => {
                        promises.push(fetch('https://api.openai.com/v1/responses', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + apiKey
                            },
                            body: JSON.stringify({
                                model: "gpt-4.1-mini",
                                input: hasUploadedImages ? [{
                                    "role": "user",
                                    "content": [
                                        {
                                            "type": "input_text",
                                            "text": prompt
                                        },
                                        ...inputContent.filter(item => item.type === "input_image")
                                    ]
                                }] : prompt,
                                tools: [{
                                    type: "image_generation",
                                    quality: "high", // Use high quality for final generation
                                    size: "1024x1024",
                                    background: "opaque"
                                }]
                            })
                        }).then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        }));
                    });
                    
                    const results = await Promise.all(promises);
                    console.log('Fresh generation results:', results);
                    
                    // Process results into expected format
                    data = {
                        output: []
                    };
                    
                    results.forEach((result, index) => {
                        console.log(`Fresh result ${index + 1}:`, result);
                        if (result.output && Array.isArray(result.output)) {
                            const imageCall = result.output.find(output => output.type === "image_generation_call");
                            if (imageCall) {
                                data.output.push(imageCall);
                            }
                        }
                    });
                    
                    console.log('Fresh generation combined data:', data);
                }
                
                // Remove loading indicator
                const loading = document.getElementById('image-loading');
                if (loading) loading.remove();
                
                // Extract image data from response
                const imageGenerationCalls = data.output?.filter(output => output.type === "image_generation_call") || [];
                
                // Debug: Log how many images we got
                console.log(`Total images generated: ${imageGenerationCalls.length}`);
                console.log('Image generation calls:', imageGenerationCalls);
                
                if (imageGenerationCalls.length > 0) {
                    console.log(`Successfully generated ${imageGenerationCalls.length} images`);
                    const imageTypeText = hasUploadedImages ? 
                        (responses.uploaded_images.Q2_images.length > 0 ? 
                            'Based on your uploaded design' : 
                            'Inspired by your reference images') : 
                        'Generated from your preferences';
                    
                    const generationMethod = backgroundImagePromise ? 
                        'Pre-generated while you completed the questionnaire' : 
                        'Generated fresh for your design';
                    
                    // Create classic ecommerce layout
                    const ecommerceContainer = document.createElement('div');
                    ecommerceContainer.className = 'ecommerce-layout';
                    
                    // Left side: Product images
                    const imagesSection = document.createElement('div');
                    imagesSection.className = 'product-images-section';
                    imagesSection.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h2 style="font-size: 24px; font-weight: 500; color: #000000; margin: 0 0 8px 0;">Your Custom Charm Designs</h2>
                            <p style="font-size: 14px; color: #666666; margin: 0;">${imageTypeText} • Choose your favorite style</p>
                        </div>
                    `;
                    
                    const imageGrid = document.createElement('div');
                    imageGrid.className = 'product-image-grid';
                    
                    // Display only the first 2 generated images
                    const imagesToDisplay = imageGenerationCalls.slice(0, 2);
                    console.log(`Displaying ${imagesToDisplay.length} images out of ${imageGenerationCalls.length} total`);
                    
                    imagesToDisplay.forEach((call, index) => {
                        if (call.result) {
                            // Convert base64 to blob URL for display
                            const base64Data = call.result;
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: 'image/png' });
                            const imageUrl = URL.createObjectURL(blob);
                            
                            const designType = index === 0 ? 'Classic Elegant' : 'Modern Sculptural';
                            const imageCard = document.createElement('div');
                            imageCard.className = 'product-image-card';
                            imageCard.id = `image-card-${index + 1}`;
                            imageCard.innerHTML = `
                                <div class="image-container">
                                    <div class="image-badge">Design ${index + 1}</div>
                                    <img src="${imageUrl}" alt="Generated charm design ${index + 1}" class="product-image" data-version="1">
                                </div>
                                
                                <div class="image-info">
                                    <h3 class="image-title">${designType}</h3>
                                    <p class="image-subtitle">Custom charm design</p>
                                    
                                    <div class="select-image-text" onclick="selectDesign(${index + 1})" id="select-btn-${index + 1}">
                                        <div class="select-checkbox" id="checkbox-${index + 1}">
                                            <span class="checkbox-check" style="display: none;">✓</span>
                                        </div>
                                        <span>Select This Design</span>
                                    </div>
                                    
                                    <div class="refine-section">
                                        <button class="refine-toggle" onclick="toggleRefineSection(${index + 1})">
                                            <span>Need changes? (Optional)</span>
                                            <span id="refine-arrow-${index + 1}">▼</span>
                                        </button>
                                        
                                        <div class="refine-content" id="refine-content-${index + 1}">
                                            <textarea 
                                                class="refine-textarea"
                                                id="feedback-${index + 1}" 
                                                placeholder="Quick changes... (e.g., more delicate, add details)"
                                            ></textarea>
                                            <button 
                                                class="refine-button"
                                                onclick="regenerateDesign(${index + 1})"
                                            >
                                                Update
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            imageGrid.appendChild(imageCard);
                            
                            // Generate story for the sidebar (only once for the first design)
                            if (index === 0) {
                                // Use the new charm image analysis for more accurate stories
                                setTimeout(() => generateStoryFromCharmImage(imageUrl, responses), 100);
                            }
                        }
                    });
                    
                    imagesSection.appendChild(imageGrid);
                    
                    // Right side: Purchase sidebar
                    const purchaseSidebar = document.createElement('div');
                    purchaseSidebar.className = 'purchase-sidebar';
                    purchaseSidebar.innerHTML = `
                        <div class="purchase-header">
                            <h2 class="purchase-title">Complete Your Order</h2>
                            <p class="purchase-subtitle">Select design and material to continue</p>
                        </div>
                        
                        <div class="design-story-section" id="sidebar-story" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #DAE0FF;">
                            <h6 style="margin: 0 0 8px 0; color: #000000; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">The Story</h6>
                            <p style="margin: 0; color: #333333; font-size: 14px; line-height: 1.5; font-style: italic; font-weight: 400;">Generating your design story...</p>
                        </div>
                        
                        <div class="selection-status" id="selection-status">
                            <div style="font-size: 14px; color: #666;">
                                <div>Design: <span id="selected-design-text">Not selected</span></div>
                                <div>Material: <span id="selected-material-text">Sterling Silver</span></div>
                            </div>
                        </div>
                        
                        <div class="material-section">
                            <div class="section-label">Choose Material</div>
                            <div class="material-dropdown">
                                <select class="material-select" id="material-select">
                                    <option value="sterling-silver">Sterling Silver</option>
                                    <option value="gold-plated">Gold-Plated</option>
                                    <option value="14k-gold">14K Gold</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="price-summary">
                            <div class="price-details">
                                <div class="price-label">Total:</div>
                                <div class="price-amount" id="main-price-display">$50</div>
                            </div>
                            <div class="shipping-info">
                                <div style="font-weight: 500; margin-bottom: 2px;">Free shipping</div>
                                <div>Ships in 5-7 days</div>
                            </div>
                        </div>
                        
                        <div id="checkout-disabled-text" class="checkout-disabled-text">
                            Select a design to checkout
                        </div>
                        
                        <button 
                            class="buy-button"
                            id="main-buy-button"
                            onclick="purchaseSelectedDesign()"
                            style="display: none;"
                        >Buy</button>
                        
                        <div class="trust-signals">
                            30-day guarantee • Secure Stripe checkout • Gift ready packaging
                        </div>
                    `;
                    
                    // Add both sections to the ecommerce container
                    ecommerceContainer.appendChild(imagesSection);
                    ecommerceContainer.appendChild(purchaseSidebar);
                    
                    resultsDiv.appendChild(ecommerceContainer);
                    
                    // Design summary section at the bottom
                    const summarySection = document.createElement('div');
                    summarySection.className = 'design-summary-section';
                    
                    // Get user responses for summary
                    const displayData = {
                        'Journey Type': responses.journey_type === 'A' ? 'Exploratory Design' : responses.journey_type === 'B' ? 'Idea Refinement' : 'Direct Creation',
                        'Email': responses.email || 'Not provided',
                        'Phone': responses.phone || 'Not provided',
                        'Material': getOptionText(responses.material),
                        'Style': getOptionText(responses.size_presence),
                        'Community Share': responses.community_share || 'Not specified'
                    };
                    
                    // Add vibe if selected
                    if (responses.style_vibes && responses.style_vibes.length > 0) {
                        displayData['Style Vibes'] = responses.style_vibes.map(v => getVibeText(v)).join(', ');
                    }
                    
                    let summaryItemsHTML = '';
                    for (const [key, value] of Object.entries(displayData)) {
                        summaryItemsHTML += `
                            <div class="summary-item">
                                <span class="summary-label">${key}:</span>
                                <span class="summary-value">${value}</span>
                            </div>
                        `;
                    }
                    
                    summarySection.innerHTML = `
                        <h3>Your Design Summary</h3>
                        <div class="summary-details">
                            ${summaryItemsHTML}
                        </div>
                    `;
                    
                    resultsDiv.appendChild(summarySection);
                    
                    // Set default material selection
                    setTimeout(() => {
                        const userMaterialChoice = responses.material || 'sterling-silver';
                        selectMaterial(userMaterialChoice);
                    }, 100);
                } else {
                    console.error('No valid images generated. Data received:', data);
                    
                    // Show detailed error information
                    const resultsDiv = document.querySelector('.results');
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = `
                        <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">Image Generation Issue</h4>
                            <p style="margin: 0 0 10px 0; color: #856404; font-size: 14px;">
                                We're experiencing a temporary issue with image generation. This can happen due to:
                            </p>
                            <ul style="margin: 0 0 15px 20px; color: #856404; font-size: 14px;">
                                <li>API rate limits or temporary service issues</li>
                                <li>Complex prompts that need adjustment</li>
                                <li>Network connectivity problems</li>
                            </ul>
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                <strong>Don't worry!</strong> We've saved all your design preferences and will create your custom charm manually. 
                                You'll receive your design mockup within 24-48 hours via email.
                            </p>
                        </div>
                    `;
                    resultsDiv.appendChild(errorDiv);
                    return; // Exit gracefully instead of throwing
                }
                
            } catch (error) {
                console.error('Error generating image:', error);
                
                // Remove loading indicator
                const loading = document.getElementById('image-loading');
                if (loading) loading.remove();
                
                // Check if the error is due to missing API key
                if (error.message === 'API key not available') {
                    console.log('API key error detected, attempting to reload configuration...');
                    
                    // Try to reload configuration
                    const configReloaded = await ensureConfigLoaded();
                    
                    if (configReloaded) {
                        console.log('Configuration reloaded successfully, retrying image generation...');
                        // Retry image generation once
                        try {
                            await generateCharmImage();
                            return; // Exit if successful
                        } catch (retryError) {
                            console.error('Retry failed:', retryError);
                        }
                    }
                    
                    // Show specific error message for API key issues
                    const resultsDiv = document.querySelector('.results');
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = `
                        <div style="text-align: center; margin: 20px 0; padding: 20px; border: 1px solid #ddd; background: #f9f9f9;">
                            <h3 style="color: #000; margin-bottom: 15px;">Image Generation Unavailable</h3>
                            <p style="color: #666; margin-bottom: 15px;">
                                We're unable to generate images right now due to a configuration issue.
                            </p>
                            <p style="color: #666; margin-bottom: 20px;">
                                <strong>Don't worry!</strong> We've captured all your design preferences and will create your custom charm manually.
                            </p>
                            <div style="background: #DAE0FF; padding: 15px; border-radius: 5px; margin-top: 15px;">
                                <p style="color: #000; font-weight: 500; margin-bottom: 10px;">What happens next:</p>
                                <ul style="text-align: left; color: #333; margin-left: 20px;">
                                    <li>Our designers will create your charm based on your responses</li>
                                    <li>You'll receive design mockups within 24-48 hours</li>
                                    <li>We'll work with you to perfect the design before production</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    resultsDiv.appendChild(errorDiv);
                } else {
                    // Show generic error message for other errors
                    const resultsDiv = document.querySelector('.results');
                    const errorDiv = document.createElement('div');
                    errorDiv.innerHTML = `
                        <div style="text-align: center; margin: 20px 0; padding: 20px; border: 1px solid #ddd; background: #f9f9f9;">
                            <h3 style="color: #000; margin-bottom: 15px;">Creating Your Design</h3>
                            <p style="color: #666; margin-bottom: 15px;">
                                We're experiencing high demand for our AI design generator right now.
                            </p>
                            <p style="color: #666; margin-bottom: 20px;">
                                <strong>No problem!</strong> Our expert designers will create your custom charm manually using all the preferences you've shared.
                            </p>
                            <div style="background: #DAE0FF; padding: 15px; border-radius: 5px; margin-top: 15px;">
                                <p style="color: #000; font-weight: 500; margin-bottom: 10px;">Your design process:</p>
                                <ul style="text-align: left; color: #333; margin-left: 20px;">
                                    <li>Hand-crafted design based on your detailed responses</li>
                                    <li>Professional mockups delivered within 24-48 hours</li>
                                    <li>Unlimited revisions until you love it</li>
                                    <li>Higher quality than AI-generated designs</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    resultsDiv.appendChild(errorDiv);
                }
            }
        }

        function getOptionText(value) {
            const mapping = {
                'subtle': 'Subtle & delicate',
                'bold-sculptural': 'Bold & sculptural',
                'classic': 'Classic & balanced',
                'not-sure': 'Not sure yet',
                '14k-gold': '14K Solid Gold',
                'sterling-silver': 'Sterling Silver (925)',
                'gold-plated': 'Gold-Plated Silver',
                'help-decide': 'Help me decide'
            };
            return mapping[value] || value;
        }

        function getVibeText(value) {
            const mapping = {
                'elegant': 'Elegant & Timeless',
                'bold': 'Bold & Confident',
                'playful': 'Playful & Cute',
                'spiritual': 'Spiritual & Symbolic',
                'sweet': 'Sweet & Sentimental'
            };
            return mapping[value] || value;
        }

        // Carousel navigation functions
        function previousDesign(designNumber) {
            const track = document.getElementById(`track-${designNumber}`);
            const images = track.querySelectorAll('img');
            const currentIndex = parseInt(track.dataset.currentIndex || '0');
            
            if (currentIndex > 0) {
                const newIndex = currentIndex - 1;
                track.style.transform = `translateX(-${newIndex * 100}%)`;
                track.dataset.currentIndex = newIndex;
                updateCarouselIndicator(designNumber, newIndex + 1, images.length);
            }
        }

        function nextDesign(designNumber) {
            const track = document.getElementById(`track-${designNumber}`);
            const images = track.querySelectorAll('img');
            const currentIndex = parseInt(track.dataset.currentIndex || '0');
            
            if (currentIndex < images.length - 1) {
                const newIndex = currentIndex + 1;
                track.style.transform = `translateX(-${newIndex * 100}%)`;
                track.dataset.currentIndex = newIndex;
                updateCarouselIndicator(designNumber, newIndex + 1, images.length);
            }
        }

        function updateCarouselIndicator(designNumber, current, total) {
            const indicator = document.getElementById(`indicator-${designNumber}`);
            indicator.textContent = `${current} of ${total}`;
            
            // Show/hide controls based on whether there are multiple images
            const controls = indicator.parentElement;
            if (total > 1) {
                controls.style.display = 'flex';
            } else {
                controls.style.display = 'none';
            }
        }

        let selectedDesignNumber = null;
        let selectedMaterial = 'sterling-silver'; // Default material

        function selectMaterial(material) {
            selectedMaterial = material;
            
            // Update dropdown selection
            const dropdown = document.getElementById('material-select');
            if (dropdown) {
                dropdown.value = material;
            }
            
            // Update price display
            updateMainPrice();
            
            // Update selection status
            updateSelectionStatus();
            
            // Check if we can enable the buy button
            updateBuyButton();
        }

        function selectDesign(designNumber) {
            selectedDesignNumber = designNumber;
            
            // Update design selection styling
            document.querySelectorAll('.select-image-text').forEach(textEl => {
                textEl.classList.remove('selected');
                const checkbox = textEl.querySelector('.checkbox-check');
                if (checkbox) {
                    checkbox.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.product-image-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedBtn = document.getElementById(`select-btn-${designNumber}`);
            const selectedCard = document.getElementById(`image-card-${designNumber}`);
            
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
                const checkbox = selectedBtn.querySelector('.checkbox-check');
                if (checkbox) {
                    checkbox.style.display = 'block';
                }
            }
            
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Update selection status
            updateSelectionStatus();
            
            // Check if we can enable the buy button
            updateBuyButton();
        }

        function updateSelectionStatus() {
            const statusDiv = document.getElementById('selection-status');
            const designText = document.getElementById('selected-design-text');
            const materialText = document.getElementById('selected-material-text');
            
            if (designText) {
                if (selectedDesignNumber) {
                    const designType = selectedDesignNumber === 1 ? 'Classic Elegant' : 'Modern Sculptural';
                    designText.textContent = `Design ${selectedDesignNumber} (${designType})`;
                } else {
                    designText.textContent = 'Not selected';
                }
            }
            
            if (materialText) {
                const materialNames = {
                    'sterling-silver': 'Sterling Silver',
                    'gold-plated': 'Gold-Plated',
                    '14k-gold': '14K Gold'
                };
                materialText.textContent = materialNames[selectedMaterial] || 'Sterling Silver';
            }
            
            if (statusDiv) {
                if (selectedDesignNumber && selectedMaterial) {
                    statusDiv.classList.add('has-selection');
                } else {
                    statusDiv.classList.remove('has-selection');
                }
            }
        }

        function updateBuyButton() {
            const buyButton = document.getElementById('main-buy-button');
            const disabledText = document.getElementById('checkout-disabled-text');
            
            if (selectedDesignNumber && selectedMaterial) {
                buyButton.style.display = 'block';
                buyButton.textContent = 'Buy';
                buyButton.removeAttribute('disabled');
                
                if (disabledText) {
                    disabledText.style.display = 'none';
                }
            } else {
                buyButton.style.display = 'none';
                buyButton.setAttribute('disabled', 'true');
                
                if (disabledText) {
                    disabledText.style.display = 'block';
                }
            }
        }

        function updateMainPrice() {
            const priceDisplay = document.getElementById('main-price-display');
            
            const prices = {
                'sterling-silver': '$50',
                'gold-plated': '$50',
                '14k-gold': '$200'
            };
            
            if (priceDisplay) {
                priceDisplay.textContent = prices[selectedMaterial];
            }
        }

        function purchaseSelectedDesign() {
            if (!selectedDesignNumber) {
                alert('Please select a design first.');
                return;
            }
            
            if (!selectedMaterial) {
                alert('Please select a material first.');
                return;
            }
            
            purchaseSpecificDesign(selectedDesignNumber, selectedMaterial);
        }

        function toggleRefineSection(designNumber) {
            const content = document.getElementById(`refine-content-${designNumber}`);
            const arrow = document.getElementById(`refine-arrow-${designNumber}`);
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                if (arrow) arrow.textContent = '▲';
            } else {
                content.style.display = 'none';
                if (arrow) arrow.textContent = '▼';
            }
        }

        function purchaseSpecificDesign(designNumber, material) {
            // Capture all form data for the purchase
            const responses = captureAllResponses();
            
            // Store design data in localStorage for the Stripe success page
            const purchaseData = {
                designNumber: designNumber,
                material: material,
                email: responses.email,
                phone: responses.phone,
                designResponses: responses,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('jewelryPurchaseData', JSON.stringify(purchaseData));
            
            // Stripe checkout URLs
            const stripeUrls = {
                'sterling-silver': 'https://buy.stripe.com/14AbJ05fH2R3ffwadNbEA01',
                'gold-plated': 'https://buy.stripe.com/fZueVc23vdvH2sK85FbEA02',
                '14k-gold': 'https://buy.stripe.com/bJe8wObE5crD8R84TtbEA03'
            };
            
            // Add purchase tracking
            console.log('Purchase initiated:', {
                designNumber: designNumber,
                material: material,
                email: responses.email,
                timestamp: new Date().toISOString()
            });
            
            // Show confirmation before redirect
            const materialNames = {
                'sterling-silver': 'Sterling Silver ($50)',
                'gold-plated': 'Gold-Plated Silver ($50)',
                '14k-gold': '14K Gold ($200)'
            };
            
            const confirmed = confirm(`Purchase: Design ${designNumber} in ${materialNames[material]}\n\nFree shipping included\n30-day guarantee\nSecure Stripe checkout\n\nProceed to checkout?`);
            
            if (confirmed) {
                // Open Stripe checkout in new tab
                window.open(stripeUrls[material], '_blank');
                
                // Show success message on current page
                showPurchaseInitiatedMessage(material, designNumber);
            }
        }

        // Legacy function for backward compatibility
        function purchaseDesign(material) {
            purchaseSpecificDesign(1, material);
        }

        function showPurchaseInitiatedMessage(material, designNumber = null) {
            const materialNames = {
                'sterling-silver': 'Sterling Silver',
                'gold-plated': 'Gold-Plated Silver', 
                '14k-gold': '14K Gold'
            };
            
            const designText = designNumber ? ` Design ${designNumber}` : '';
            
            // Create success overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            overlay.innerHTML = `
                <div style="background: white; padding: 40px; border: 2px solid #000000; text-align: center; max-width: 550px; margin: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 15px 0; color: #000; font-size: 26px; font-weight: 500;">Purchase Initiated!</h3>
                    <div style="background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; margin-bottom: 20px;">
                        <p style="margin: 0; color: #000000; font-size: 16px; font-weight: 500;">
                            Custom Charm${designText}<br>
                            <span style="color: #666; font-weight: 400;">${materialNames[material]}</span>
                        </p>
                    </div>
                    <p style="margin: 0 0 25px 0; color: #000000; font-size: 16px; line-height: 1.5; font-weight: 300;">
                        Complete your secure checkout in the window that just opened.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; text-align: left;">
                        <div style="background: #e8f5e8; padding: 12px; border: 1px solid #28a745;">
                            <div style="font-size: 14px; font-weight: 500; color: #155724; margin-bottom: 4px;">Free Shipping</div>
                            <div style="font-size: 12px; color: #155724;">No additional costs</div>
                        </div>
                        <div style="background: #e8f5e8; padding: 12px; border: 1px solid #28a745;">
                            <div style="font-size: 14px; font-weight: 500; color: #155724; margin-bottom: 4px;">Fast Delivery</div>
                            <div style="font-size: 12px; color: #155724;">5-7 business days</div>
                        </div>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 15px 25px; background: #000000; color: #ffffff; border: none; font-size: 16px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;" onmouseover="this.style.background='#333333';" onmouseout="this.style.background='#000000';">
                        Continue Shopping
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.remove();
                }
            }, 10000);
        }

        async function generateDesignStory(responses, designType) {
            try {
                // Get API key
                let apiKey = window.CONFIG?.OPENAI_API_KEY || window.OPENAI_API_KEY;
                if (!apiKey) {
                    console.log('No API key available for story generation');
                    const storySection = document.getElementById('sidebar-story');
                    if (storySection) {
                        storySection.innerHTML = `
                            <h6 style="margin: 0 0 8px 0; color: #000000; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">The Story</h6>
                            <p style="margin: 0; color: #333333; font-size: 14px; line-height: 1.5; font-style: italic; font-weight: 400;">Story generation unavailable - API key required</p>
                        `;
                    }
                    return;
                }
                
                // Check if we have uploaded images to analyze
                const hasUploadedImages = responses.uploaded_images.Q2_images.length > 0 || 
                                        responses.uploaded_images.Q7_images.length > 0 || 
                                        responses.uploaded_images.Q9_images.length > 0;
                
                let storyPrompt = '';
                let messages = [];
                
                if (hasUploadedImages) {
                    // Use GPT-4o to analyze the uploaded reference images and create a story about what the charm represents
                    const imageAnalysisPrompt = `Look at this reference image and write exactly 1-2 simple, heartfelt sentences about what this would mean as a custom charm.

Focus on what you see in the image - the subject, symbols, or elements - and describe the emotional significance and personal connection this would have as a charm. Use warm, simple language that describes what the charm actually represents.

Consider what story this image tells and why someone would want to carry this specific design as a charm close to their heart. Be specific about what you see rather than generic.`;
                    
                    // Build messages array with image content
                    const messageContent = [
                        {
                            "type": "text",
                            "text": imageAnalysisPrompt
                        }
                    ];
                    
                    // Add all uploaded images
                    const allImages = [
                        ...responses.uploaded_images.Q2_images,
                        ...responses.uploaded_images.Q7_images,
                        ...responses.uploaded_images.Q9_images
                    ];
                    
                    allImages.forEach(imageBase64 => {
                        messageContent.push({
                            "type": "image_url",
                            "image_url": {
                                "url": imageBase64
                            }
                        });
                    });
                    
                    messages = [{
                        "role": "user",
                        "content": messageContent
                    }];
                } else {
                    // Build comprehensive emotional and sentimental context from ALL user responses
                    let emotionalStory = '';
                    let personalElements = [];
                    let sentimentalContext = '';
                    
                    // Journey-specific emotional context
                    if (responses.journey_type === 'A') {
                        // Path A: Need help with ideas
                        if (responses.inspiration?.includes('moment')) {
                            emotionalStory = 'celebrating a milestone that changed everything';
                            sentimentalContext = 'This charm holds the joy and pride of that transformative moment, keeping its power close to your heart.';
                        } else if (responses.inspiration?.includes('person')) {
                            emotionalStory = 'honoring someone who means the world to you';
                            sentimentalContext = 'This charm carries their love and influence with you, a tangible reminder of the bond you share.';
                        } else if (responses.inspiration?.includes('place')) {
                            emotionalStory = 'preserving memories of somewhere that shaped you';
                            sentimentalContext = 'This charm brings that special place with you wherever you go, holding its magic in your everyday life.';
                        } else if (responses.inspiration?.includes('curious')) {
                            emotionalStory = 'expressing your unique spirit and creativity';
                            sentimentalContext = 'This charm reflects who you are at your core, celebrating your individual beauty and style.';
                        }
                    } else if (responses.journey_type === 'B') {
                        // Path B: Have some ideas
                        if (responses.all_text_responses.Q8_idea_description) {
                            const idea = responses.all_text_responses.Q8_idea_description.toLowerCase();
                            emotionalStory = `bringing your vision to life: "${responses.all_text_responses.Q8_idea_description}"`;
                            sentimentalContext = 'This charm transforms your dreams into something you can touch and treasure every day.';
                        } else {
                            emotionalStory = 'turning inspiration into something deeply personal';
                            sentimentalContext = 'This charm captures your creative spirit and makes it part of your story.';
                        }
                    } else if (responses.journey_type === 'C') {
                        // Path C: Know exactly what they want
                        emotionalStory = 'preserving something precious in permanent form';
                        sentimentalContext = 'This charm keeps your most treasured memories alive, turning moments into lasting keepsakes.';
                    }
                    
                    // Add meaningful symbols/elements to personal story
                    if (responses.all_text_responses.Q6_symbols) {
                        personalElements.push(`meaningful symbols: ${responses.all_text_responses.Q6_symbols}`);
                    }
                    
                    // Add special details/requests to personal story
                    if (responses.all_text_responses.Q13_special_details) {
                        personalElements.push(`special touches: ${responses.all_text_responses.Q13_special_details}`);
                    }
                    
                    // Add style vibes to emotional context
                    let emotionalVibes = '';
                    if (responses.style_vibes && responses.style_vibes.length > 0) {
                        const vibes = responses.style_vibes;
                        if (vibes.includes('elegant')) emotionalVibes += ' timeless and graceful,';
                        if (vibes.includes('bold')) emotionalVibes += ' confident and empowering,';
                        if (vibes.includes('playful')) emotionalVibes += ' joyful and lighthearted,';
                        if (vibes.includes('spiritual')) emotionalVibes += ' deeply meaningful and sacred,';
                        if (vibes.includes('sweet')) emotionalVibes += ' tender and heartwarming,';
                        emotionalVibes = emotionalVibes.replace(/,$/, ''); // Remove trailing comma
                        if (emotionalVibes) {
                            emotionalVibes = ` The design feels${emotionalVibes}.`;
                        }
                    }
                    
                    // Recipient emotional context
                    let recipientStory = '';
                    if (responses.recipient === 'for-me') {
                        recipientStory = 'Every time you wear it, you\'ll feel connected to what matters most.';
                    } else if (responses.recipient === 'for-someone') {
                        recipientStory = 'This gift will remind them how much they mean to you, carrying your love wherever they go.';
                    } else {
                        recipientStory = 'This piece will hold deep meaning for whoever wears it.';
                    }
                    
                    // Build personal elements string
                    let personalElementsText = '';
                    if (personalElements.length > 0) {
                        personalElementsText = ` It includes ${personalElements.join(' and ')}.`;
                    }
                    
                    // Create a focused, sentimental prompt that describes what the charm actually is
                    storyPrompt = `Write exactly 1-2 simple, heartfelt sentences about this custom charm's meaning and what it represents.

The person is ${emotionalStory}.${personalElementsText}${emotionalVibes} ${sentimentalContext} ${recipientStory}

Focus on what the charm actually depicts and symbolizes, describing the specific elements and their emotional significance. Use warm, simple language that tells what this charm is and why it matters. Be specific about the charm's design rather than generic.`;
                    
                    // Add actual prompt context if available
                    if (imageGenerationPrompts.design1 || imageGenerationPrompts.basePrompt) {
                        const actualPrompt = imageGenerationPrompts.design1 || imageGenerationPrompts.basePrompt;
                        storyPrompt = storyPrompt.replace(
                            'Focus on what the charm actually depicts',
                            `ACTUAL DESIGN PROMPT USED: "${actualPrompt}"\n\nFocus on what the charm actually depicts`
                        );
                    }
                    
                    messages = [{
                        "role": "user",
                        "content": storyPrompt
                    }];
                }
                
                console.log('Generating story with', hasUploadedImages ? 'GPT-4o (with image analysis)' : 'GPT-4o-mini (text only)');
                
                // Use GPT-4o for image analysis, GPT-4o-mini for text-only
                const model = hasUploadedImages ? "gpt-4o" : "gpt-4o-mini";
                
                // Make API call
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        max_tokens: 120,
                        temperature: 0.8 // Balanced creativity for heartfelt stories
                    })
                });
                
                if (!response.ok) {
                    console.error('Story generation API error:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error details:', errorText);
                    throw new Error(`API request failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    const story = data.choices[0].message.content.trim();
                    
                    // Update the story section in the sidebar
                    const storySection = document.getElementById('sidebar-story');
                    if (storySection) {
                        storySection.innerHTML = `
                            <h6 style="margin: 0 0 8px 0; color: #000000; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">The Story</h6>
                            <p style="margin: 0; color: #333333; font-size: 14px; line-height: 1.5; font-style: italic; font-weight: 400;">${story}</p>
                        `;
                    }
                    
                    console.log('Story generated successfully:', story);
                } else {
                    console.error('Invalid response from story generation API:', data);
                    throw new Error('Invalid response from story generation API');
                }
                
            } catch (error) {
                console.error('Error generating design story:', error);
                
                // Show improved contextual fallback messages with more sentimental focus
                const storySection = document.getElementById('sidebar-story');
                if (storySection) {
                    let fallbackStory = '';
                    
                    // Create heartfelt, sentimental fallback stories
                    // Create more specific fallback stories based on what the charm actually represents
                    let charmSubject = 'charm';
                    if (responses.all_text_responses.Q6_symbols) {
                        charmSubject = responses.all_text_responses.Q6_symbols.toLowerCase();
                    } else if (responses.all_text_responses.Q8_idea_description) {
                        charmSubject = responses.all_text_responses.Q8_idea_description.toLowerCase();
                    }
                    
                    if (responses.journey_type === 'A') {
                        if (responses.inspiration?.includes('moment')) {
                            fallbackStory = `This ${charmSubject} charm captures the joy and significance of your special moment, transforming it into something you can carry and treasure every day.`;
                        } else if (responses.inspiration?.includes('person')) {
                            fallbackStory = `This ${charmSubject} charm represents the love and bond you share with someone special, keeping their presence close to your heart.`;
                        } else if (responses.inspiration?.includes('place')) {
                            fallbackStory = `This ${charmSubject} charm embodies the spirit and memories of a place that shaped you, bringing its essence into your daily life.`;
                        } else {
                            fallbackStory = `This ${charmSubject} charm reflects your unique personality and creative spirit, celebrating what makes you beautifully you.`;
                        }
                    } else if (responses.journey_type === 'B') {
                        if (responses.all_text_responses.Q8_idea_description) {
                            fallbackStory = `This ${charmSubject} charm brings your personal vision to life, transforming your idea into a meaningful piece you can touch and treasure.`;
                        } else {
                            fallbackStory = `This ${charmSubject} charm transforms your inspiration into something deeply personal, carrying your unique story wherever you go.`;
                        }
                    } else {
                        fallbackStory = `This ${charmSubject} charm preserves what's precious to you, turning cherished memories into a beautiful keepsake you can always carry.`;
                    }
                    
                    // Add personal elements if they exist
                    if (responses.all_text_responses.Q6_symbols || responses.all_text_responses.Q13_special_details) {
                        fallbackStory += ' Every detail holds meaning that\'s uniquely yours.';
                    }
                    
                    storySection.innerHTML = `
                        <h6 style="margin: 0 0 8px 0; color: #000000; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">The Story</h6>
                        <p style="margin: 0; color: #333333; font-size: 14px; line-height: 1.5; font-style: italic; font-weight: 400;">${fallbackStory}</p>
                    `;
                }
            }
        }

        async function regenerateDesign(designNumber) {
            try {
                const feedbackTextarea = document.getElementById(`feedback-${designNumber}`);
                const feedback = feedbackTextarea.value.trim();
                
                if (!feedback) {
                    alert('Please provide feedback about what you\'d like to change in this design.');
                    return;
                }
                
                // Get API key
                let apiKey = window.CONFIG?.OPENAI_API_KEY || window.OPENAI_API_KEY;
                if (!apiKey) {
                    throw new Error("API key not available");
                }
                
                // Show loading state
                const button = feedbackTextarea.nextElementSibling;
                if (!button) {
                    alert('Could not find the update button. Please try again.');
                    return;
                }
                const originalText = button.textContent;
                button.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div class="swimming-logo-container" style="height: 20px; margin: 0;">
                            <svg class="swimming-logo" style="height: 16px;" version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300.000000 166.000000" preserveAspectRatio="xMidYMid meet">
                                <g transform="translate(0.000000,166.000000) scale(0.100000,-0.100000)" fill="#666666" stroke="none">
                                    <path d="M186 1478 c16 -222 84 -401 209 -547 25 -29 45 -56 43 -60 -2 -3 -29 -50 -61 -104 -96 -161 -171 -366 -202 -554 l-7 -42 94 40 c126 55 255 127 363 204 95 68 295 249 295 267 0 6 -17 25 -37 43 l-38 33 -90 -87 c-50 -47 -125 -112 -168 -144 -87 -66 -246 -162 -254 -154 -10 11 40 143 95 250 30 60 81 144 113 187 l58 79 -37 31 c-94 77 -189 226 -231 364 -31 102 -31 103 47 61 144 -79 302 -225 501 -463 112 -134 297 -316 401 -393 367 -273 719 -319 1070 -138 162 83 355 258 469 423 62 90 64 70 -28 200 -65 92 -200 232 -287 298 -183 140 -353 200 -559 200 -285 -1 -579 -132 -823 -367 -106 -101 -105 -100 -40 -146 l29 -21 92 89 c215 204 461 319 707 330 150 6 234 -11 365 -76 156 -77 299 -201 416 -360 l47 -65 -31 -45 c-17 -25 -67 -84 -112 -130 -206 -215 -424 -321 -660 -322 -333 -2 -639 196 -1026 661 -217 260 -428 424 -644 500 -27 10 -58 21 -67 25 -15 6 -16 0 -12 -67z"/>
                                    <path d="M2194 1090 c-35 -14 -64 -59 -64 -99 0 -86 80 -141 154 -106 130 62 44 259 -90 205z"/>
                                </g>
                            </svg>
                        </div>
                        <span>Regenerating...</span>
                    </div>`;
                button.disabled = true;
                button.style.background = '#ccc';
                
                // Get current responses and prompt data
                const responses = captureAllResponses();
                const promptData = generatePromptFromResponses(responses);
                
                // Check if we have uploaded images
                const hasUploadedImages = responses.uploaded_images.Q2_images.length > 0 || 
                                        responses.uploaded_images.Q7_images.length > 0 || 
                                        responses.uploaded_images.Q9_images.length > 0;
                
                // Build the regeneration prompt based on the design number and feedback
                const designType = designNumber === 1 ? 'Classic Elegant' : 'Modern Sculptural';
                
                // Create detailed preferences (same format as original generation)
                let detailedPreferences = `
USER SURVEY RESPONSES TO INCORPORATE:
- Material: ${promptData.material}
- Style: ${promptData.style}
- Subject/Theme: ${promptData.subject}`;

                if (responses.inspiration) detailedPreferences += `\n- Story/Inspiration: ${responses.inspiration}`;
                if (responses.symbols) detailedPreferences += `\n- Requested Symbols/Elements: ${responses.symbols}`;
                if (responses.style_vibes && responses.style_vibes.length > 0) detailedPreferences += `\n- Style Vibes: ${responses.style_vibes.join(', ')}`;
                if (responses.size_presence) detailedPreferences += `\n- Size Preference: ${responses.size_presence}`;
                if (responses.special_details) detailedPreferences += `\n- Special Details: ${responses.special_details}`;

                // Add image description if user uploaded images
                if (hasUploadedImages) {
                    detailedPreferences += `\n- Reference Images: User provided reference images for inspiration (incorporate the style and elements from their uploaded references)`;
                }

                const regenerationPrompt = `Create a single ${promptData.subject} charm with an attachment loop. Design style: ${designType}.

User preferences:
- Material: ${promptData.material}
- Style: ${promptData.style}
- Subject: ${promptData.subject}${responses.inspiration ? `\n- Inspiration: ${responses.inspiration}` : ''}${responses.symbols ? `\n- Elements: ${responses.symbols}` : ''}${responses.style_vibes && responses.style_vibes.length > 0 ? `\n- Style vibes: ${responses.style_vibes.join(', ')}` : ''}${responses.size_presence ? `\n- Size preference: ${responses.size_presence}` : ''}${responses.special_details ? `\n- Special details: ${responses.special_details}` : ''}

Design type: ${designType === 'Classic Elegant' ? 'Classic elegant style with refined details, clean lines, and timeless aesthetic' : 'Modern sculptural style with bold 3D forms and contemporary geometric shapes'}

User feedback: ${feedback}

Create an improved ${designType} charm design that incorporates the user feedback while maintaining the specified style. The design should be a single, unified charm piece. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                
                // Store the regeneration prompt for story generation
                imageGenerationPrompts.regenerated[designNumber] = regenerationPrompt;
                console.log(`Stored regeneration prompt for design ${designNumber}:`, regenerationPrompt);
                
                // Make API call using the same endpoint and format as original generation
                const response = await fetch('https://api.openai.com/v1/responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: "gpt-4.1-mini",
                        input: regenerationPrompt,
                        tools: [{
                            type: "image_generation",
                            quality: "high", // Use high quality to match original generation
                            size: "1024x1024",
                            background: "opaque"
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('GPT API error:', response.status, errorData);
                    throw new Error(`GPT API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                
                // Extract image from GPT response (same format as original generation)
                let newImageUrl = null;
                if (data.output && Array.isArray(data.output)) {
                    const imageCall = data.output.find(output => output.type === "image_generation_call");
                    if (imageCall && imageCall.result) {
                        // Convert base64 to blob URL for display (same as original generation)
                        const base64Data = imageCall.result;
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: 'image/png' });
                        newImageUrl = URL.createObjectURL(blob);
                    }
                }
                
                if (newImageUrl) {
                    // Add the new image to the carousel instead of replacing
                    const success = addImageToCarousel(designNumber, newImageUrl);
                    
                    if (success) {
                        // Clear the feedback textarea
                        feedbackTextarea.value = '';
                        
                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 8px; border-radius: 4px; margin-top: 10px; font-size: 12px; text-align: center;';
                        successMsg.textContent = `New version of Design ${designNumber} added to carousel!`;
                        feedbackTextarea.parentElement.appendChild(successMsg);
                        
                        // Remove success message after 3 seconds
                        setTimeout(() => {
                            if (successMsg.parentElement) {
                                successMsg.parentElement.removeChild(successMsg);
                            }
                        }, 3000);
                        
                        // Regenerate story with the new image for design 1 only (since that's what shows in sidebar)
                        if (designNumber === 1) {
                            const responses = captureAllResponses();
                            setTimeout(() => generateStoryFromCharmImage(newImageUrl, responses), 500);
                        }
                    } else {
                        alert('Could not add the new image to the carousel. Please try again.');
                    }
                } else {
                    throw new Error('No image generated');
                }
                
            } catch (error) {
                console.error('Error regenerating design:', error);
                alert('Sorry, there was an error regenerating the design. Please try again.');
            } finally {
                // Reset button state
                const feedbackTextarea = document.querySelector(`#feedback-${designNumber}`);
                if (feedbackTextarea && feedbackTextarea.nextElementSibling) {
                    const button = feedbackTextarea.nextElementSibling;
                    button.textContent = 'Update';
                    button.disabled = false;
                    button.style.background = '#f8f8f8';
                }
            }
        }

        // Enable continue button for text inputs (auto-advance removed to prevent skipping)
        document.querySelectorAll('textarea, input[type="email"], input[type="tel"]').forEach(input => {
            input.addEventListener('input', function() {
                const continueBtn = this.closest('.question-container').querySelector('.btn-primary');
                if (continueBtn) {
                    // For contact form, only enable button when email is valid
                    if (this.closest('[data-question="contact"]')) {
                        const emailInput = this.closest('.question-container').querySelector('#contact-email');
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        continueBtn.disabled = !emailInput || !emailRegex.test(emailInput.value);
                    } else {
                    continueBtn.disabled = this.value.trim() === '';
                    }
                }
                
                // Auto-save text input progress
                const questionId = this.closest('.question-container').dataset.question;
                if (questionId) {
                    if (this.type === 'email') {
                        formData.email = this.value;
                    } else if (this.type === 'tel') {
                        formData.phone = this.value;
                    } else {
                        formData[questionId] = this.value;
                    }
                }
                
                // Clear any existing timer
                clearTimeout(window.textInputTimer);
                
                // Removed auto-advance for text inputs - let users manually continue
                // This prevents questions from being skipped while users are still typing
                // Previously: Q8 had auto-advance after 2 seconds, but this caused issues
            });
            
            // Handle Enter key for immediate advancement
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    if (this.tagName === 'TEXTAREA') {
                        e.preventDefault();
                    }
                    const continueBtn = this.closest('.question-container').querySelector('.btn-primary');
                    if (continueBtn && !continueBtn.disabled) {
                        continueBtn.click();
                    }
                }
            });
        });



        // Fix image preview issue by ensuring the preview container is properly appended
        function showImagePreviews(files, fileInfo) {
            console.log('Showing image previews for', files.length, 'files');
            
            // Clear existing previews and containers
            const container = fileInfo.parentElement;
            const existingPreviews = container.querySelectorAll('.image-preview');
            const existingContainers = container.querySelectorAll('.image-preview-container');
            existingPreviews.forEach(preview => preview.remove());
            existingContainers.forEach(cont => cont.remove());
            
            if (files.length === 0) {
                console.log('No files to preview');
                return;
            }
            
            // Create a container for all previews
            const previewContainer = document.createElement('div');
            previewContainer.className = 'image-preview-container';
            previewContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: center;';
            
            // Append container immediately to avoid timing issues
            container.appendChild(previewContainer);
            
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    console.log('Processing image file:', file.name);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log('Image loaded:', file.name);
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'image-preview';
                        previewDiv.style.cssText = 'text-align: center; flex: 0 0 auto;';
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Preview" style="max-width: 120px; max-height: 120px; border: 2px solid #000; border-radius: 8px; object-fit: cover;">
                            <p style="font-size: 11px; color: #666; margin: 5px 0 0 0; max-width: 120px; word-break: break-word;">${file.name}</p>
                        `;
                        previewContainer.appendChild(previewDiv);
                    };
                    reader.onerror = function(error) {
                        console.error('Error reading file:', file.name, error);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Iframe detection and optimization
        function detectIframe() {
            try {
                const isInIframe = window.self !== window.top;
                if (isInIframe) {
                    document.body.classList.add('in-iframe');
                    console.log('Running in iframe - applying optimizations');
                    
                    // Add iframe-specific styles
                    const style = document.createElement('style');
                    style.textContent = `
                        .in-iframe .container {
                            margin: 0;
                            border-radius: 0;
                        }
                        
                        .in-iframe body {
                            padding: 5px;
                            min-height: auto;
                        }
                        
                        .in-iframe .container.results-mode {
                            max-width: 100vw;
                        }
                        
                        @media (max-width: 1000px) {
                            .in-iframe .ecommerce-layout {
                                grid-template-columns: 1fr;
                                gap: 10px;
                            }
                            
                            .in-iframe .purchase-sidebar {
                                order: -1;
                                padding: 15px;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
            } catch (e) {
                // Cross-origin iframe - can't detect, but assume we might be in one
                console.log('Possible cross-origin iframe');
            }
        }

        // Initialize
        detectIframe();
        
        // Always start fresh from Q1 - no save states
        clearQuizProgress();
        showQuestion('Q1');
        
        addArrowToButtons();
        
        // Setup drag and drop once when page loads
        let dragDropInitialized = false;
        
        function initializeDragDrop() {
            if (!dragDropInitialized) {
                setupDragAndDrop();
                dragDropInitialized = true;
                console.log('Drag and drop setup complete');
            }
        }
        
        // Setup drag and drop after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeDragDrop, 200);
        });

        // Add event listener for material dropdown when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for material dropdown
            const materialDropdown = document.getElementById('material-select');
            if (materialDropdown) {
                materialDropdown.addEventListener('change', function() {
                    selectMaterial(this.value);
                });
            }
        });

        // Carousel navigation functions
        function navigateCarousel(designNumber, direction) {
            const track = document.getElementById(`track-${designNumber}`);
            if (!track) return;
            
            const images = track.querySelectorAll('img');
            const totalImages = images.length;
            if (totalImages <= 1) return;
            
            let currentIndex = parseInt(track.dataset.currentIndex) || 0;
            
            if (direction === 'prev') {
                currentIndex = currentIndex > 0 ? currentIndex - 1 : totalImages - 1;
            } else {
                currentIndex = currentIndex < totalImages - 1 ? currentIndex + 1 : 0;
            }
            
            track.dataset.currentIndex = currentIndex;
            track.style.transform = `translateX(-${currentIndex * 100}%)`;
            
            updateCarouselIndicator(designNumber, currentIndex + 1, totalImages);
            updateCarouselButtons(designNumber, currentIndex, totalImages);
        }

        function updateCarouselIndicator(designNumber, current, total) {
            const indicator = document.getElementById(`indicator-${designNumber}`);
            if (indicator) {
                indicator.textContent = `${current} of ${total}`;
            }
        }

        function updateCarouselButtons(designNumber, currentIndex, totalImages) {
            const prevBtn = document.getElementById(`prev-${designNumber}`);
            const nextBtn = document.getElementById(`next-${designNumber}`);
            
            if (prevBtn) prevBtn.disabled = currentIndex === 0;
            if (nextBtn) nextBtn.disabled = currentIndex === totalImages - 1;
        }

        function convertToCarousel(designNumber, existingImageSrc) {
            const designContainer = document.querySelector(`#image-card-${designNumber}`);
            if (!designContainer) return null;
            
            const imageContainer = designContainer.querySelector('.image-container');
            if (!imageContainer) return null;
            
            // Create carousel structure
            const carouselContainer = document.createElement('div');
            carouselContainer.className = 'carousel-container';
            carouselContainer.innerHTML = `
                <div class="carousel-track" id="track-${designNumber}" data-current-index="0">
                    <img src="${existingImageSrc}" alt="Generated charm design ${designNumber} - Version 1" class="product-image" data-version="1" style="min-width: 100%; width: 100%; height: auto; display: block; object-fit: contain; border: none; outline: none; background: transparent; margin: 0; padding: 0;">
                </div>
                <div class="carousel-controls">
                    <button class="carousel-btn" id="prev-${designNumber}" onclick="navigateCarousel(${designNumber}, 'prev')" disabled>‹</button>
                    <span class="carousel-indicator" id="indicator-${designNumber}">1 of 1</span>
                    <button class="carousel-btn" id="next-${designNumber}" onclick="navigateCarousel(${designNumber}, 'next')" disabled>›</button>
                </div>
            `;
            
            // Replace the simple image with carousel
            const existingImage = imageContainer.querySelector('.product-image');
            if (existingImage) {
                existingImage.parentNode.replaceChild(carouselContainer, existingImage);
            }
            
            return carouselContainer.querySelector('.carousel-track');
        }

        function addImageToCarousel(designNumber, newImageSrc) {
            let track = document.getElementById(`track-${designNumber}`);
            
            // If no carousel exists, convert the existing image to a carousel first
            if (!track) {
                const existingImage = document.querySelector(`#image-card-${designNumber} .product-image`);
                if (existingImage) {
                    track = convertToCarousel(designNumber, existingImage.src);
                }
            }
            
            if (!track) return false;
            
            // Get current number of images
            const currentImages = track.querySelectorAll('img');
            const newVersion = currentImages.length + 1;
            
            // Create new image element
            const newImage = document.createElement('img');
            newImage.src = newImageSrc;
            newImage.alt = `Generated charm design ${designNumber} - Version ${newVersion}`;
            newImage.className = 'product-image';
            newImage.dataset.version = newVersion;
            newImage.style.cssText = 'min-width: 100%; width: 100%; height: auto; display: block; object-fit: contain; border: none; outline: none; background: transparent; margin: 0; padding: 0;';
            
            // Add to track
            track.appendChild(newImage);
            
            // Navigate to the new image
            const newIndex = newVersion - 1;
            track.dataset.currentIndex = newIndex;
            track.style.transform = `translateX(-${newIndex * 100}%)`;
            
            // Update controls
            updateCarouselIndicator(designNumber, newVersion, newVersion);
            updateCarouselButtons(designNumber, newIndex, newVersion);
            
            return true;
        }

        async function regenerateDesign(designNumber) {
            try {
                const feedbackTextarea = document.getElementById(`feedback-${designNumber}`);
                const feedback = feedbackTextarea.value.trim();
                
                if (!feedback) {
                    alert('Please provide feedback about what you\'d like to change in this design.');
                    return;
                }
                
                // Get API key
                let apiKey = window.CONFIG?.OPENAI_API_KEY || window.OPENAI_API_KEY;
                if (!apiKey) {
                    throw new Error("API key not available");
                }
                
                // Show loading state
                const button = feedbackTextarea.nextElementSibling;
                if (!button) {
                    alert('Could not find the update button. Please try again.');
                    return;
                }
                const originalText = button.textContent;
                button.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div class="swimming-logo-container" style="height: 20px; margin: 0;">
                            <svg class="swimming-logo" style="height: 16px;" version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300.000000 166.000000" preserveAspectRatio="xMidYMid meet">
                                <g transform="translate(0.000000,166.000000) scale(0.100000,-0.100000)" fill="#666666" stroke="none">
                                    <path d="M186 1478 c16 -222 84 -401 209 -547 25 -29 45 -56 43 -60 -2 -3 -29 -50 -61 -104 -96 -161 -171 -366 -202 -554 l-7 -42 94 40 c126 55 255 127 363 204 95 68 295 249 295 267 0 6 -17 25 -37 43 l-38 33 -90 -87 c-50 -47 -125 -112 -168 -144 -87 -66 -246 -162 -254 -154 -10 11 40 143 95 250 30 60 81 144 113 187 l58 79 -37 31 c-94 77 -189 226 -231 364 -31 102 -31 103 47 61 144 -79 302 -225 501 -463 112 -134 297 -316 401 -393 367 -273 719 -319 1070 -138 162 83 355 258 469 423 62 90 64 70 -28 200 -65 92 -200 232 -287 298 -183 140 -353 200 -559 200 -285 -1 -579 -132 -823 -367 -106 -101 -105 -100 -40 -146 l29 -21 92 89 c215 204 461 319 707 330 150 6 234 -11 365 -76 156 -77 299 -201 416 -360 l47 -65 -31 -45 c-17 -25 -67 -84 -112 -130 -206 -215 -424 -321 -660 -322 -333 -2 -639 196 -1026 661 -217 260 -428 424 -644 500 -27 10 -58 21 -67 25 -15 6 -16 0 -12 -67z"/>
                                    <path d="M2194 1090 c-35 -14 -64 -59 -64 -99 0 -86 80 -141 154 -106 130 62 44 259 -90 205z"/>
                                </g>
                            </svg>
                        </div>
                        <span>Regenerating...</span>
                    </div>`;
                button.disabled = true;
                button.style.background = '#ccc';
                
                // Get current responses and prompt data
                const responses = captureAllResponses();
                const promptData = generatePromptFromResponses(responses);
                
                // Check if we have uploaded images
                const hasUploadedImages = responses.uploaded_images.Q2_images.length > 0 || 
                                        responses.uploaded_images.Q7_images.length > 0 || 
                                        responses.uploaded_images.Q9_images.length > 0;
                
                // Build the regeneration prompt based on the design number and feedback
                const designType = designNumber === 1 ? 'Classic Elegant' : 'Modern Sculptural';
                
                // Create detailed preferences (same format as original generation)
                let detailedPreferences = `
USER SURVEY RESPONSES TO INCORPORATE:
- Material: ${promptData.material}
- Style: ${promptData.style}
- Subject/Theme: ${promptData.subject}`;

                if (responses.inspiration) detailedPreferences += `\n- Story/Inspiration: ${responses.inspiration}`;
                if (responses.symbols) detailedPreferences += `\n- Requested Symbols/Elements: ${responses.symbols}`;
                if (responses.style_vibes && responses.style_vibes.length > 0) detailedPreferences += `\n- Style Vibes: ${responses.style_vibes.join(', ')}`;
                if (responses.size_presence) detailedPreferences += `\n- Size Preference: ${responses.size_presence}`;
                if (responses.special_details) detailedPreferences += `\n- Special Details: ${responses.special_details}`;

                // Add image description if user uploaded images
                if (hasUploadedImages) {
                    detailedPreferences += `\n- Reference Images: User provided reference images for inspiration (incorporate the style and elements from their uploaded references)`;
                }

                const regenerationPrompt = `Create a single ${promptData.subject} charm with an attachment loop. Design style: ${designType}.

User preferences:
- Material: ${promptData.material}
- Style: ${promptData.style}
- Subject: ${promptData.subject}${responses.inspiration ? `\n- Inspiration: ${responses.inspiration}` : ''}${responses.symbols ? `\n- Elements: ${responses.symbols}` : ''}${responses.style_vibes && responses.style_vibes.length > 0 ? `\n- Style vibes: ${responses.style_vibes.join(', ')}` : ''}${responses.size_presence ? `\n- Size preference: ${responses.size_presence}` : ''}${responses.special_details ? `\n- Special details: ${responses.special_details}` : ''}

Design type: ${designType === 'Classic Elegant' ? 'Classic elegant style with refined details, clean lines, and timeless aesthetic' : 'Modern sculptural style with bold 3D forms and contemporary geometric shapes'}

User feedback: ${feedback}

Create an improved ${designType} charm design that incorporates the user feedback while maintaining the specified style. The design should be a single, unified charm piece. ${promptData.lighting}. ${promptData.background}. ${promptData.presentation}. ${promptData.camera}.`;
                
                // Store the regeneration prompt for story generation
                imageGenerationPrompts.regenerated[designNumber] = regenerationPrompt;
                console.log(`Stored regeneration prompt for design ${designNumber}:`, regenerationPrompt);
                
                // Make API call using the same endpoint and format as original generation
                const response = await fetch('https://api.openai.com/v1/responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: "gpt-4.1-mini",
                        input: regenerationPrompt,
                        tools: [{
                            type: "image_generation",
                            quality: "high", // Use high quality to match original generation
                            size: "1024x1024",
                            background: "opaque"
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('GPT API error:', response.status, errorData);
                    throw new Error(`GPT API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                
                // Extract image from GPT response (same format as original generation)
                let newImageUrl = null;
                if (data.output && Array.isArray(data.output)) {
                    const imageCall = data.output.find(output => output.type === "image_generation_call");
                    if (imageCall && imageCall.result) {
                        // Convert base64 to blob URL for display (same as original generation)
                        const base64Data = imageCall.result;
                        const byteCharacters = atob(base64Data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        const blob = new Blob([byteArray], { type: 'image/png' });
                        newImageUrl = URL.createObjectURL(blob);
                    }
                }
                
                if (newImageUrl) {
                    // Add the new image to the carousel instead of replacing
                    const success = addImageToCarousel(designNumber, newImageUrl);
                    
                    if (success) {
                        // Clear the feedback textarea
                        feedbackTextarea.value = '';
                        
                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = 'background: #d4edda; color: #155724; padding: 8px; border-radius: 4px; margin-top: 10px; font-size: 12px; text-align: center;';
                        successMsg.textContent = `New version of Design ${designNumber} added to carousel!`;
                        feedbackTextarea.parentElement.appendChild(successMsg);
                        
                        // Remove success message after 3 seconds
                        setTimeout(() => {
                            if (successMsg.parentElement) {
                                successMsg.parentElement.removeChild(successMsg);
                            }
                        }, 3000);
                        
                        // Regenerate story with the new image for design 1 only (since that's what shows in sidebar)
                        if (designNumber === 1) {
                            const responses = captureAllResponses();
                            setTimeout(() => generateStoryFromCharmImage(newImageUrl, responses), 500);
                        }
                    } else {
                        alert('Could not add the new image to the carousel. Please try again.');
                    }
                } else {
                    throw new Error('No image generated');
                }
                
            } catch (error) {
                console.error('Error regenerating design:', error);
                alert('Sorry, there was an error regenerating the design. Please try again.');
            } finally {
                // Reset button state
                const feedbackTextarea = document.querySelector(`#feedback-${designNumber}`);
                if (feedbackTextarea && feedbackTextarea.nextElementSibling) {
                    const button = feedbackTextarea.nextElementSibling;
                    button.textContent = 'Update';
                    button.disabled = false;
                    button.style.background = '#f8f8f8';
                }
            }
        }
    </script>
</body>
</html>